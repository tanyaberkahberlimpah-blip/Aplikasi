<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catatan Keuangan Pribadi</title>
  <script src="/_sdk/<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catatan Keuangan Pribadi</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-card: #ffffff;
      --text-primary: #1a1a1a;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      --teal: #14b8a6;
      --teal-dark: #0d9488;
      --income: #10b981;
      --expense: #ef4444;
      --saving: #3b82f6;
      --investment: #8b5cf6;
    }

    .dark-mode {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border-color: #334155;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      --teal: #2dd4bf;
      --teal-dark: #14b8a6;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      transition: background 0.3s, color 0.3s;
    }

    .summary-card-gradient {
      background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%);
      border-radius: 24px;
      padding: 28px;
      box-shadow: 0 8px 32px rgba(20, 184, 166, 0.25);
      position: relative;
      overflow: hidden;
    }

    .summary-card-gradient::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 200px;
      height: 200px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      filter: blur(60px);
    }

    .wallet-icon {
      font-size: 28px;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.15));
    }

    .savings-badge {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      padding: 6px 12px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .sub-card-income {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .sub-card-income:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      background: rgba(255, 255, 255, 0.35);
    }

    .sub-card-expense {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .sub-card-expense:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      background: rgba(255, 255, 255, 0.35);
    }

    .arrow-icon-income {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      font-weight: bold;
    }

    .arrow-icon-expense {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      font-weight: bold;
    }

    .app-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: var(--shadow);
      transition: all 0.3s;
    }

    .text-secondary {
      color: var(--text-secondary);
    }

    .btn-primary {
      background: var(--teal);
      color: white;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      background: var(--teal-dark);
      transform: translateY(-1px);
    }

    .income-color {
      color: #059669;
    }

    .expense-color {
      color: #dc2626;
    }

    .saving-color {
      color: var(--saving);
    }

    .investment-color {
      color: var(--investment);
    }

    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .filter-btn.active {
      background: var(--teal);
      color: white;
      border-color: var(--teal);
    }

    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--teal);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(20, 184, 166, 0.4);
      cursor: pointer;
      transition: all 0.2s;
      z-index: 100;
    }

    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(20, 184, 166, 0.5);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 16px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 400px;
      max-height: 90%;
      overflow-y: auto;
    }

    input, select, textarea {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 8px;
      padding: 12px;
      width: 100%;
      transition: all 0.2s;
      font-size: 14px;
    }

    select option {
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 10px;
    }

    #transaction-type {
      font-weight: 600;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--teal);
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 24px;
      background: var(--border-color);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: var(--teal);
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.active .toggle-slider {
      transform: translateX(24px);
    }

    .category-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .delete-btn {
      background: var(--expense);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .delete-btn:hover {
      opacity: 0.8;
    }

    .loading-spinner {
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--teal);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .theme-color-btn {
      cursor: pointer;
      transition: all 0.2s;
    }

    .theme-color-btn:hover {
      transform: scale(1.1);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-pulse {
      animation: pulse 2s ease-in-out infinite;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-connected {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }

    .status-disconnected {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: var(--bg-primary);
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 300;
      animation: fadeInOut 2s;
      max-width: 90%;
      text-align: center;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
      10% { opacity: 1; transform: translateX(-50%) translateY(0); }
      90% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app-wrapper" class="h-full w-full overflow-auto">
   <div class="max-w-md mx-auto p-4" style="padding-bottom: 100px;"><!-- Header -->
    <header class="mb-6">
     <div class="flex items-center justify-between mb-4">
      <h1 id="app-title" class="text-2xl font-bold">Catatan Keuangan Pribadi</h1>
      <div class="flex items-center gap-2"><button id="export-btn" class="p-2 rounded-full hover:bg-opacity-10" style="background: var(--bg-secondary);" title="Export Data">ğŸ“¥</button> <button id="theme-toggle" class="p-2 rounded-full hover:bg-opacity-10" style="background: var(--bg-secondary);"> <span id="theme-icon">ğŸŒ™</span> </button> <button id="settings-btn" class="p-2 rounded-full" style="background: var(--bg-secondary);">âš™ï¸</button>
      </div>
     </div><!-- Real-time Info Bar -->
     <div class="flex items-center justify-between mb-4 p-3 rounded-lg" style="background: var(--bg-secondary);">
      <div class="flex items-center gap-3">
       <div class="flex items-center gap-2"><span class="text-lg">ğŸ•</span> <span id="real-time-clock" class="text-sm font-semibold" style="font-variant-numeric: tabular-nums;">00:00:00</span>
       </div>
       <div class="flex items-center gap-2"><span class="text-lg">ğŸ“</span> <span class="text-sm text-secondary">Jakarta, Indonesia</span>
       </div>
      </div>
      <div class="flex items-center gap-2">
       <div class="flex items-center gap-1">
        <div id="status-indicator" class="w-2 h-2 rounded-full status-pulse" style="background: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);"></div><span id="status-text" class="text-xs font-semibold" style="color: #10b981;">Online</span>
       </div>
      </div>
     </div>
     <div class="grid grid-cols-2 gap-2"><select id="month-select" class="w-full"> <option value="0">Januari</option> <option value="1">Februari</option> <option value="2">Maret</option> <option value="3">April</option> <option value="4">Mei</option> <option value="5">Juni</option> <option value="6">Juli</option> <option value="7">Agustus</option> <option value="8">September</option> <option value="9">Oktober</option> <option value="10">November</option> <option value="11">Desember</option> </select> <select id="year-select" class="w-full"></select>
     </div>
    </header><!-- Summary Card -->
    <div class="summary-card-gradient mb-6">
     <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-2">
       <div class="wallet-icon">
        ğŸ‘›
       </div>
       <h2 id="summary-title" class="text-xl font-bold text-white">Keuanganmu</h2>
      </div>
      <div class="savings-badge"><span class="text-xs">ğŸ¦</span> <span class="text-xs font-semibold" id="balance-percentage">0%</span>
      </div>
     </div>
     <div class="mb-1 text-sm text-white" style="opacity: 0.9;">
      Saldo Bersih
     </div>
     <div class="text-5xl font-bold text-white mb-6" id="net-balance">
      Rp0
     </div>
     <div class="grid grid-cols-2 gap-3 mb-4">
      <div class="sub-card-income">
       <div class="flex items-center gap-2 mb-2">
        <div class="arrow-icon-income">
         â†“
        </div><span class="text-sm font-medium" style="color: white;">Pemasukan</span>
       </div>
       <div class="text-xl font-bold income-color" id="total-income" style="color: white;">
        Rp0
       </div>
      </div>
      <div class="sub-card-expense">
       <div class="flex items-center gap-2 mb-2">
        <div class="arrow-icon-expense">
         â†‘
        </div><span class="text-sm font-medium" style="color: white;">Pengeluaran</span>
       </div>
       <div class="text-xl font-bold expense-color" id="total-expense" style="color: white;">
        Rp0
       </div>
      </div>
     </div>
     <div class="grid grid-cols-1 gap-3"><button id="report-btn" class="py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all hover:scale-105" style="background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); color: white; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);"> <span class="text-lg">ğŸ“Š</span> <span>Laporan</span> </button>
     </div>
    </div><!-- Chart -->
    <div class="app-card p-6 mb-6">
     <div class="flex items-center justify-between mb-4">
      <h3 class="font-semibold">Distribusi Keuangan</h3>
      <div class="flex gap-2"><button class="chart-filter-btn active" data-chart-filter="income" style="padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--teal); color: white; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;"> Pemasukan </button> <button class="chart-filter-btn" data-chart-filter="expense" style="padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;"> Pengeluaran </button>
      </div>
     </div>
     <div class="flex flex-col items-center"><!-- Donut Chart -->
      <div class="relative" style="width: 200px; height: 200px; margin-bottom: 20px;">
       <svg id="donut-chart" viewbox="0 0 200 200" style="transform: rotate(-90deg);"><circle cx="100" cy="100" r="80" fill="none" stroke="var(--bg-secondary)" stroke-width="40" /> <circle id="income-arc" cx="100" cy="100" r="80" fill="none" stroke="var(--income)" stroke-width="40" stroke-dasharray="0 502.65" stroke-linecap="round" style="transition: stroke-dasharray 0.5s ease;" /> <circle id="expense-arc" cx="100" cy="100" r="80" fill="none" stroke="var(--expense)" stroke-width="40" stroke-dasharray="0 502.65" stroke-linecap="round" style="transition: stroke-dasharray 0.5s ease;" />
       </svg>
       <div class="absolute inset-0 flex flex-col items-center justify-center">
        <div class="text-xs text-secondary mb-1">
         Total
        </div>
        <div class="text-xl font-bold" id="chart-total">
         Rp0
        </div>
       </div>
      </div><!-- Legend -->
      <div class="w-full space-y-3">
       <div id="income-legend" class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-secondary);">
        <div class="flex items-center gap-2">
         <div style="width: 16px; height: 16px; border-radius: 4px; background: var(--income);"></div><span class="text-sm font-medium">Pemasukan</span>
        </div>
        <div class="flex items-center gap-2"><span class="text-xs font-bold income-color" id="chart-income-percentage">0%</span> <span class="text-sm font-semibold income-color" id="chart-income">Rp0</span>
        </div>
       </div>
       <div id="expense-legend" class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-secondary);">
        <div class="flex items-center gap-2">
         <div style="width: 16px; height: 16px; border-radius: 4px; background: var(--expense);"></div><span class="text-sm font-medium">Pengeluaran</span>
        </div>
        <div class="flex items-center gap-2"><span class="text-xs font-bold expense-color" id="chart-expense-percentage">0%</span> <span class="text-sm font-semibold expense-color" id="chart-expense">Rp0</span>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Transactions -->
    <div class="app-card p-6">
     <div class="flex items-center justify-between mb-4">
      <h3 class="font-semibold">Transaksi</h3>
      <div class="text-sm text-secondary" id="total-transactions">
       Rp0
      </div>
     </div>
     <div class="flex gap-2 mb-4 overflow-x-auto pb-2" style="scrollbar-width: thin;"><button class="filter-btn active" data-filter="all">Semua</button> <button class="filter-btn" data-filter="income">ğŸ’° Pemasukan</button> <button class="filter-btn" data-filter="expense">ğŸ’¸ Pengeluaran</button> <button class="filter-btn" data-filter="saving">ğŸ¦ Tabungan</button> <button class="filter-btn" data-filter="investment">ğŸ“Š Investasi</button>
     </div>
     <div id="transactions-list" class="space-y-3"></div>
     <div id="empty-state" class="text-center py-8 text-secondary" style="display: none;">
      <div class="text-4xl mb-2">
       ğŸ’°
      </div>
      <p>Belum ada transaksi</p>
      <p class="text-sm">Klik tombol + untuk menambah transaksi</p>
     </div>
    </div>
   </div><!-- FAB --> <button class="fab" id="add-transaction-btn">+</button> <!-- Report Modal -->
   <div class="modal-overlay" id="report-modal">
    <div class="modal-content" style="max-width: 500px;">
     <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold">Laporan Bulanan</h3><button id="close-report-modal" class="text-2xl">Ã—</button>
     </div>
     <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Pilih Bulan</label> <select id="report-month" class="w-full"> <option value="0">Januari</option> <option value="1">Februari</option> <option value="2">Maret</option> <option value="3">April</option> <option value="4">Mei</option> <option value="5">Juni</option> <option value="6">Juli</option> <option value="7">Agustus</option> <option value="8">September</option> <option value="9">Oktober</option> <option value="10">November</option> <option value="11">Desember</option> </select>
     </div>
     <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Tahun</label> <select id="report-year" class="w-full"></select>
     </div>
     <div id="report-content" class="space-y-4"></div><button id="export-report-btn" class="btn-primary w-full py-3 rounded-lg font-semibold mt-4"> ğŸ“¥ Export Laporan (CSV) </button>
    </div>
   </div><!-- Settings Modal -->
   <div class="modal-overlay" id="settings-modal">
    <div class="modal-content">
     <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold">Pengaturan</h3><button id="close-settings-modal" class="text-2xl">Ã—</button>
     </div>
     <div class="space-y-4">
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center gap-3 mb-3">
        <div class="text-2xl">
         ğŸ‘¤
        </div>
        <div>
         <div class="font-semibold">
          Profil Pengguna
         </div>
         <div class="text-sm text-secondary">
          Kelola informasi akun
         </div>
        </div>
       </div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-3">
         <div class="text-2xl">
          ğŸ¨
         </div>
         <div>
          <div class="font-semibold">
           Tema Warna
          </div>
          <div class="text-sm text-secondary">
           Pilih warna utama aplikasi
          </div>
         </div>
        </div>
       </div>
       <div class="flex gap-2 mt-3"><button class="theme-color-btn" data-color="#14b8a6" style="background: #14b8a6; width: 40px; height: 40px; border-radius: 8px; border: 2px solid var(--text-primary);"></button> <button class="theme-color-btn" data-color="#3b82f6" style="background: #3b82f6; width: 40px; height: 40px; border-radius: 8px; border: 2px solid transparent;"></button> <button class="theme-color-btn" data-color="#8b5cf6" style="background: #8b5cf6; width: 40px; height: 40px; border-radius: 8px; border: 2px solid transparent;"></button> <button class="theme-color-btn" data-color="#ec4899" style="background: #ec4899; width: 40px; height: 40px; border-radius: 8px; border: 2px solid transparent;"></button> <button class="theme-color-btn" data-color="#f59e0b" style="background: #f59e0b; width: 40px; height: 40px; border-radius: 8px; border: 2px solid transparent;"></button>
       </div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
         <div class="text-2xl">
          ğŸŒ™
         </div>
         <div>
          <div class="font-semibold">
           Mode Gelap
          </div>
          <div class="text-sm text-secondary">
           Toggle tema gelap/terang
          </div>
         </div>
        </div>
        <div class="toggle-switch" id="settings-theme-toggle">
         <div class="toggle-slider"></div>
        </div>
       </div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center gap-3">
        <div class="text-2xl">
         â˜ï¸
        </div>
        <div>
         <div class="font-semibold">
          Sinkronisasi Cloud
         </div>
         <div class="text-sm text-secondary">
          Data tersimpan di Canva Sheet
         </div>
         <div class="text-xs mt-1" style="color: var(--income);">
          âœ… Tersinkronisasi
         </div>
        </div>
       </div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-3">
         <div class="text-2xl">
          ğŸ“Š
         </div>
         <div>
          <div class="font-semibold">
           Google Sheets
          </div>
          <div class="text-sm text-secondary">
           Sinkronisasi ke Google Sheets
          </div>
         </div>
        </div>
        <div id="google-sheets-status-badge" class="status-badge status-connected"><span>ğŸŸ¢</span> <span>Connected</span>
        </div>
       </div><button id="connect-google-sheets-btn" class="btn-primary w-full py-2 rounded-lg font-semibold mb-2"> âš™ï¸ Manage Connection </button> <button id="load-from-sheets-btn" class="w-full py-2 rounded-lg font-semibold" style="background: var(--bg-secondary); color: var(--text-primary);"> ğŸ“¥ Load Data dari Google Sheets </button>
       <div id="google-sheets-info" style="display: none;" class="mt-3 p-3 rounded-lg">
        <div class="text-xs text-secondary mb-2">
         ğŸ“ Instruksi Setup:
        </div>
        <ol class="text-xs text-secondary space-y-1 ml-4" style="list-style: decimal;">
         <li>Buat Google Sheet baru</li>
         <li>Tools â†’ Script Editor</li>
         <li>Paste kode Apps Script</li>
         <li>Deploy â†’ New deployment</li>
         <li>Copy Web App URL</li>
        </ol>
       </div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center gap-3">
        <div class="text-2xl">
         ğŸ’¾
        </div>
        <div>
         <div class="font-semibold">
          Backup &amp; Restore
         </div>
         <div class="text-sm text-secondary">
          Cadangkan data transaksi
         </div>
        </div>
       </div><button id="backup-btn" class="btn-primary w-full py-2 rounded-lg font-semibold mt-3"> Backup Data </button>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center gap-3">
        <div class="text-2xl">
         ğŸ’±
        </div>
        <div>
         <div class="font-semibold">
          Mata Uang
         </div>
         <div class="text-sm text-secondary">
          Rupiah (IDR)
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Google Sheets Connect Modal -->
   <div class="modal-overlay" id="google-sheets-modal">
    <div class="modal-content">
     <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold">ğŸ“Š Connect Google Sheets</h3><button id="close-google-sheets-modal" class="text-2xl">Ã—</button>
     </div>
     <div class="mb-4 p-4 rounded-lg" style="background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6;">
      <div class="text-sm font-semibold mb-2" style="color: #3b82f6;">
       ğŸ“ Cara Setup Google Sheets
      </div>
      <ol class="text-sm text-secondary space-y-2 ml-4" style="list-style: decimal;">
       <li>Buat <strong>Google Sheet baru</strong></li>
       <li>Klik menu <strong>Extensions â†’ Apps Script</strong></li>
       <li>Hapus kode default, lalu paste kode Apps Script di bawah</li>
       <li>Klik <strong>Deploy â†’ New deployment</strong></li>
       <li>Type: <strong>Web app</strong></li>
       <li>Execute as: <strong>Me</strong></li>
       <li>Who has access: <strong>Anyone</strong></li>
       <li>Klik <strong>Deploy</strong> dan copy <strong>Web App URL</strong></li>
      </ol>
     </div>
     <div class="mb-4 p-4 rounded-lg" style="background: var(--bg-secondary);">
      <div class="flex items-center justify-between mb-2">
       <div class="text-sm font-semibold">
        ğŸ“‹ Kode Google Apps Script
       </div><button id="copy-script-btn" class="text-xs px-3 py-1 rounded" style="background: var(--teal); color: white;"> ğŸ“‹ Copy </button>
      </div>
      <pre id="apps-script-code" class="text-xs p-3 rounded mt-2 overflow-x-auto" style="background: var(--bg-primary); border: 1px solid var(--border-color); max-height: 200px;">function doGet(e) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Transaksi');
    
    if (!sheet) {
      return createJsonResponse({
        success: true,
        data: [],
        count: 0,
        message: 'Sheet Transaksi belum ada'
      });
    }
    
    var lastRow = sheet.getLastRow();
    
    if (lastRow &lt;= 1) {
      return createJsonResponse({
        success: true,
        data: [],
        count: 0,
        message: 'Tidak ada data'
      });
    }
    
    var dataRange = sheet.getRange(2, 1, lastRow - 1, 8);
    var values = dataRange.getValues();
    
    var transactions = [];
    for (var i = 0; i &lt; values.length; i++) {
      if (values[i][1]) {
        transactions.push({
          timestamp: values[i][0],
          kode_transaksi: values[i][1],
          tipe: values[i][2],
          kategori: values[i][3],
          jumlah: values[i][4],
          keterangan: values[i][5],
          metode_pembayaran: values[i][6],
          tanggal: values[i][7]
        });
      }
    }
    
    return createJsonResponse({
      success: true,
      data: transactions,
      count: transactions.length,
      message: 'Data berhasil diambil'
    });
    
  } catch (error) {
    return createJsonResponse({
      success: false,
      error: error.toString(),
      message: 'Gagal mengambil data'
    });
  }
}

function doPost(e) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Transaksi');
    
    if (!sheet) {
      sheet = ss.insertSheet('Transaksi');
      setupHeader(sheet);
    }
    
    if (sheet.getLastRow() === 0) {
      setupHeader(sheet);
    }
    
    var data = JSON.parse(e.postData.contents);
    
    if (data.action === 'delete') {
      return deleteTransaction(sheet, data.kode_transaksi);
    }
    
    var timestamp = new Date();
    var transactionDate = data.tanggal ? new Date(data.tanggal) : timestamp;
    
    sheet.appendRow([
      timestamp,
      data.kode_transaksi || 'TRX-' + Date.now(),
      data.tipe || 'expense',
      data.kategori || 'Lainnya',
      data.jumlah || 0,
      data.keterangan || '',
      data.metode_pembayaran || 'Tunai',
      transactionDate
    ]);
    
    return createJsonResponse({
      success: true,
      message: 'Data berhasil disimpan'
    });
    
  } catch (error) {
    return createJsonResponse({
      success: false,
      error: error.toString(),
      message: 'Gagal menyimpan data'
    });
  }
}

function setupHeader(sheet) {
  sheet.appendRow([
    'Timestamp',
    'Kode Transaksi',
    'Tipe',
    'Kategori',
    'Jumlah',
    'Keterangan',
    'Metode Pembayaran',
    'Tanggal Transaksi'
  ]);
  
  var headerRange = sheet.getRange(1, 1, 1, 8);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#14b8a6');
  headerRange.setFontColor('#ffffff');
  headerRange.setHorizontalAlignment('center');
  sheet.setFrozenRows(1);
  
  sheet.setColumnWidth(1, 150);
  sheet.setColumnWidth(2, 150);
  sheet.setColumnWidth(3, 100);
  sheet.setColumnWidth(4, 150);
  sheet.setColumnWidth(5, 100);
  sheet.setColumnWidth(6, 200);
  sheet.setColumnWidth(7, 150);
  sheet.setColumnWidth(8, 150);
}

function deleteTransaction(sheet, kodeTransaksi) {
  try {
    var lastRow = sheet.getLastRow();
    
    for (var i = 2; i &lt;= lastRow; i++) {
      var rowData = sheet.getRange(i, 2).getValue();
      if (rowData === kodeTransaksi) {
        sheet.deleteRow(i);
        return createJsonResponse({
          success: true,
          message: 'Data berhasil dihapus'
        });
      }
    }
    
    return createJsonResponse({
      success: false,
      error: 'Data tidak ditemukan',
      message: 'Transaksi tidak ditemukan'
    });
  } catch (error) {
    return createJsonResponse({
      success: false,
      error: error.toString(),
      message: 'Gagal menghapus data'
    });
  }
}

function createJsonResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}</pre>
     </div>
     <form id="google-sheets-form">
      <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Google Apps Script URL</label> <input type="url" id="google-sheets-url" placeholder="https://script.google.com/macros/s/.../exec" required>
       <div class="text-xs text-secondary mt-1">
        Paste URL dari Apps Script deployment
       </div>
      </div>
      <div class="flex gap-2"><button type="button" id="test-connection-btn" class="flex-1 py-2 rounded-lg font-semibold" style="background: var(--bg-secondary); color: var(--text-primary);"> ğŸ” Test Connection </button> <button type="submit" class="btn-primary flex-1 py-2 rounded-lg font-semibold"> ğŸ’¾ Save &amp; Connect </button>
      </div>
     </form>
     <div id="connection-result" class="mt-4" style="display: none;"></div>
    </div>
   </div><!-- Transaction Modal -->
   <div class="modal-overlay" id="transaction-modal">
    <div class="modal-content">
     <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold">Tambah Transaksi</h3><button id="close-modal" class="text-2xl">Ã—</button>
     </div>
     <form id="transaction-form">
      <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Tipe</label> <select id="transaction-type" required> <option value="income">ğŸ’° Pemasukan</option> <option value="expense">ğŸ’¸ Pengeluaran</option> <option value="saving">ğŸ¦ Tabungan</option> <option value="investment">ğŸ“Š Investasi</option> </select>
      </div>
      <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Kategori</label> <select id="transaction-category" required> <!-- Categories will be populated dynamically --> </select>
      </div>
      <div id="custom-category-form" style="display: none;" class="mb-4 p-4 rounded-lg"><label class="block text-sm mb-2 text-secondary font-semibold">Buat Kategori Baru</label>
       <div class="mb-3"><label class="block text-xs mb-1 text-secondary">Nama Kategori</label> <input type="text" id="custom-category-name" placeholder="Contoh: Kursus Online">
        <div class="text-xs text-secondary mt-1">
         Ikon akan dipilih otomatis berdasarkan tipe transaksi
        </div>
       </div><button type="button" id="add-custom-category-btn" class="btn-primary w-full py-2 rounded-lg font-semibold text-sm"> â• Tambah Kategori </button>
      </div>
      <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Jumlah</label> <input type="text" id="transaction-amount" placeholder="0" required inputmode="numeric">
      </div>
      <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Tanggal</label> <input type="date" id="transaction-date" required>
      </div>
      <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Deskripsi (opsional)</label> <input type="text" id="transaction-description" placeholder="Deskripsi (opsional)">
      </div>
      <div class="mb-6"><label class="block text-sm mb-2 text-secondary">Metode Pembayaran</label> <select id="payment-method" required> <!-- Payment methods will be populated dynamically --> </select>
      </div>
      <div id="custom-payment-form" style="display: none;" class="mb-6 p-4 rounded-lg"><label class="block text-sm mb-2 text-secondary font-semibold">Buat Metode Pembayaran Baru</label>
       <div class="mb-3"><label class="block text-xs mb-1 text-secondary">Nama Metode Pembayaran</label> <input type="text" id="custom-payment-name" placeholder="Contoh: GoPay, OVO, Dana">
       </div><button type="button" id="add-custom-payment-btn" class="btn-primary w-full py-2 rounded-lg font-semibold text-sm"> â• Tambah Metode Pembayaran </button>
      </div><button type="submit" class="btn-primary w-full py-3 rounded-lg font-semibold" id="submit-btn"> Simpan Transaksi </button>
     </form>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: "Catatan Keuangan Pribadi",
      currency_symbol: "Rp",
      summary_title: "Keuanganmu",
      background_color: "#ffffff",
      surface_color: "#f8f9fa",
      text_color: "#1a1a1a",
      primary_color: "#14b8a6",
      accent_color: "#10b981",
      font_family: "system-ui",
      font_size: 16
    };

    let transactions = [];
    let currentFilter = 'all';
    let currentChartFilter = 'income';
    let isDarkMode = false;
    let isSubmitting = false;
    let isOnline = true;
    let googleSheetsUrl = localStorage.getItem('googleSheetsUrl') || 'https://script.google.com/macros/s/AKfycbyjbuqJRs3uv7ICrdxxmjSxz_yEjs0QsHBwWrRzBa1txkmm24j7tIpTyoGc2ZFj_iG41g/exec';
    let isGoogleSheetsConnected = true;

    function updateClock() {
      try {
        const clockElement = document.getElementById('real-time-clock');
        if (clockElement) {
          const now = new Date();
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const seconds = String(now.getSeconds()).padStart(2, '0');
          clockElement.textContent = `${hours}:${minutes}:${seconds}`;
        }
      } catch (error) {
        console.error('Error updating clock:', error);
      }
    }

    setInterval(updateClock, 1000);
    updateClock();

    function updateOnlineStatus() {
      try {
        const indicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        
        if (!indicator || !statusText) return;
        
        const isConnected = isGoogleSheetsConnected && googleSheetsUrl;
        
        if (isConnected) {
          indicator.style.background = 'var(--income)';
          indicator.style.boxShadow = '0 0 8px rgba(16, 185, 129, 0.5)';
          indicator.classList.add('status-pulse');
          statusText.textContent = 'Online';
          statusText.style.color = 'var(--income)';
          isOnline = true;
        } else {
          indicator.style.background = 'var(--expense)';
          indicator.style.boxShadow = '0 0 8px rgba(239, 68, 68, 0.5)';
          indicator.classList.remove('status-pulse');
          statusText.textContent = 'Offline';
          statusText.style.color = 'var(--expense)';
          isOnline = false;
        }
      } catch (error) {
        console.error('Error updating online status:', error);
      }
    }

    function updateGoogleSheetsStatus(connected) {
      try {
        isGoogleSheetsConnected = connected;
        const statusBadge = document.getElementById('google-sheets-status-badge');
        const connectBtn = document.getElementById('connect-google-sheets-btn');
        
        if (statusBadge) {
          if (connected) {
            statusBadge.className = 'status-badge status-connected';
            statusBadge.innerHTML = '<span>ğŸŸ¢</span><span>Connected</span>';
          } else {
            statusBadge.className = 'status-badge status-disconnected';
            statusBadge.innerHTML = '<span>âš«</span><span>Not Connected</span>';
          }
        }
        
        if (connectBtn) {
          connectBtn.textContent = connected ? 'âš™ï¸ Manage Connection' : 'ğŸ”— Connect to Google Sheets';
        }
        
        updateOnlineStatus();
      } catch (error) {
        console.error('Error updating Google Sheets status:', error);
      }
    }

    async function syncToGoogleSheets(transaction) {
      if (!isGoogleSheetsConnected || !googleSheetsUrl) {
        console.log('âš ï¸ Google Sheets belum terkoneksi, skip sync');
        return { success: false, message: 'Not connected' };
      }

      try {
        console.log('ğŸ“¤ Mengirim ke Google Sheets:', googleSheetsUrl);

        const payload = {
          tanggal: new Date(transaction.created_at).toLocaleString('id-ID'),
          kode_transaksi: transaction.id,
          tipe: transaction.type,
          kategori: getCategoryName(transaction.category, transaction.type),
          jumlah: transaction.amount,
          keterangan: transaction.description || '-',
          metode_pembayaran: getPaymentMethodName(transaction.payment_method)
        };

        const response = await fetch(googleSheetsUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.success) {
            return { success: true, message: 'Sync berhasil' };
          } else {
            console.error('âŒ Google Sheets error:', data.error || data.message);
            return { success: false, message: data.message || 'Gagal sync' };
          }
        } else {
          console.error('âŒ HTTP error:', response.status);
          return { success: false, message: `HTTP error ${response.status}` };
        }
      } catch (error) {
        console.error('âŒ Error sync ke Google Sheets:', error);
        return { success: false, message: error.message };
      }
    }

    async function loadFromGoogleSheets() {
      if (!isGoogleSheetsConnected || !googleSheetsUrl) {
        showToast('âš ï¸ Google Sheets belum terkoneksi');
        return;
      }

      try {
        showToast('ğŸ”„ Memuat data dari Google Sheets...');
        
        const response = await fetch(googleSheetsUrl, {
          method: 'GET'
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success && result.data) {
            console.log('ğŸ“¥ Data dari Google Sheets:', result.data);
            
            for (const row of result.data) {
              const exists = transactions.find(t => t.id === row.kode_transaksi);
              
              if (!exists && row.kode_transaksi && row.jumlah) {
                let parsedDate = new Date();
                try {
                  if (row.tanggal) {
                    const dateStr = row.tanggal.toString();
                    parsedDate = new Date(dateStr);
                    if (isNaN(parsedDate.getTime())) {
                      parsedDate = new Date();
                    }
                  }
                } catch (e) {
                  parsedDate = new Date();
                }
                
                let categoryKey = row.kategori;
                const allCategories = {
                  ...incomeCategories,
                  ...expenseCategories,
                  ...savingCategories,
                  ...investmentCategories,
                  ...customCategories.income,
                  ...customCategories.expense,
                  ...customCategories.saving,
                  ...customCategories.investment
                };
                
                for (const [key, value] of Object.entries(allCategories)) {
                  if (value.name === row.kategori) {
                    categoryKey = key;
                    break;
                  }
                }
                
                let paymentKey = row.metode_pembayaran;
                const allPayments = { ...defaultPaymentMethods, ...customPaymentMethods };
                for (const [key, value] of Object.entries(allPayments)) {
                  if (`${value.icon} ${value.name}` === row.metode_pembayaran) {
                    paymentKey = key;
                    break;
                  }
                }
                
                const newTransaction = {
                  id: row.kode_transaksi,
                  type: row.tipe,
                  category: categoryKey,
                  amount: parseFloat(row.jumlah) || 0,
                  description: row.keterangan === '-' ? '' : row.keterangan,
                  payment_method: paymentKey,
                  created_at: parsedDate.toISOString()
                };
                
                const createResult = await window.dataSdk.create(newTransaction);
                if (!createResult.isOk) {
                  console.error('âŒ Gagal menyimpan data:', row.kode_transaksi);
                }
              }
            }
            
            showToast(`âœ… Berhasil memuat ${result.count} transaksi dari Google Sheets`);
          } else {
            showToast('âš ï¸ Tidak ada data di Google Sheets');
          }
        } else {
          showToast('âŒ Gagal mengambil data dari Google Sheets');
        }
      } catch (error) {
        console.error('âŒ Error load dari Google Sheets:', error);
        showToast('âŒ Error: ' + error.message);
      }
    }

    const incomeCategories = {
      salary: { name: 'Gaji & Pekerjaan', icon: 'ğŸ’°' },
      bonus: { name: 'Bonus', icon: 'ğŸ' },
      business: { name: 'Usaha', icon: 'ğŸ’¼' },
      freelance: { name: 'Freelance', icon: 'ğŸ’»' },
      other_income: { name: 'Lainnya', icon: 'ğŸ’µ' }
    };

    const expenseCategories = {
      household: { name: 'Rumah Tangga', icon: 'ğŸ ' },
      food: { name: 'Makanan & Minuman', icon: 'ğŸ”' },
      transport: { name: 'Transportasi', icon: 'ğŸš—' },
      bills: { name: 'Tagihan', icon: 'ğŸ“„' },
      entertainment: { name: 'Hiburan', icon: 'ğŸ®' },
      health: { name: 'Kesehatan', icon: 'ğŸ¥' },
      shopping: { name: 'Belanja', icon: 'ğŸ›ï¸' },
      other_expense: { name: 'Lainnya', icon: 'ğŸ“' }
    };

    const savingCategories = {
      emergency_fund: { name: 'Dana Darurat', icon: 'ğŸ†˜' },
      education_fund: { name: 'Dana Pendidikan', icon: 'ğŸ“' },
      vacation_fund: { name: 'Dana Liburan', icon: 'âœˆï¸' },
      house_fund: { name: 'Dana Rumah', icon: 'ğŸ¡' },
      wedding_fund: { name: 'Dana Pernikahan', icon: 'ğŸ’’' },
      retirement_fund: { name: 'Dana Pensiun', icon: 'ğŸ‘´' },
      other_saving: { name: 'Lainnya', icon: 'ğŸ¦' }
    };

    const investmentCategories = {
      stocks: { name: 'Saham', icon: 'ğŸ“ˆ' },
      mutual_funds: { name: 'Reksa Dana', icon: 'ğŸ“Š' },
      crypto: { name: 'Cryptocurrency', icon: 'ğŸ’' },
      gold: { name: 'Emas', icon: 'ğŸ¥‡' },
      property: { name: 'Properti', icon: 'ğŸ¢' },
      bonds: { name: 'Obligasi', icon: 'ğŸ“œ' },
      other_investment: { name: 'Lainnya', icon: 'ğŸ’¹' }
    };

    const customCategories = {
      income: {},
      expense: {},
      saving: {},
      investment: {}
    };

    const defaultPaymentMethods = {
      cash: { name: 'Tunai', icon: 'ğŸ’µ' },
      bank_transfer: { name: 'Transfer Bank', icon: 'ğŸ¦' },
      ewallet: { name: 'E-Wallet', icon: 'ğŸ“±' },
      debit: { name: 'Kartu Debit', icon: 'ğŸ’³' },
      credit: { name: 'Kartu Kredit', icon: 'ğŸ’³' }
    };

    const customPaymentMethods = {};

    const categoryIcons = {
      salary: 'ğŸ’°',
      bonus: 'ğŸ',
      business: 'ğŸ’¼',
      freelance: 'ğŸ’»',
      other_income: 'ğŸ’µ',
      household: 'ğŸ ',
      food: 'ğŸ”',
      transport: 'ğŸš—',
      bills: 'ğŸ“„',
      entertainment: 'ğŸ®',
      health: 'ğŸ¥',
      shopping: 'ğŸ›ï¸',
      other_expense: 'ğŸ“',
      emergency_fund: 'ğŸ†˜',
      education_fund: 'ğŸ“',
      vacation_fund: 'âœˆï¸',
      house_fund: 'ğŸ¡',
      wedding_fund: 'ğŸ’’',
      retirement_fund: 'ğŸ‘´',
      other_saving: 'ğŸ¦',
      stocks: 'ğŸ“ˆ',
      mutual_funds: 'ğŸ“Š',
      crypto: 'ğŸ’',
      gold: 'ğŸ¥‡',
      property: 'ğŸ¢',
      bonds: 'ğŸ“œ',
      other_investment: 'ğŸ’¹'
    };

    const dataHandler = {
      onDataChanged(data) {
        transactions = data;
        updateUI();
      }
    };

    async function initApp() {
      try {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          showToast('Gagal menginisialisasi aplikasi');
        }

        if (googleSheetsUrl) {
          updateGoogleSheetsStatus(true);
        } else {
          updateOnlineStatus();
        }

        const currentDate = new Date();
        const yearSelect = document.getElementById('year-select');
        if (yearSelect) {
          for (let year = 2025; year <= 2040; year++) {
            yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
          }
        }
        
        const monthSelect = document.getElementById('month-select');
        if (monthSelect) {
          monthSelect.value = currentDate.getMonth();
        }
        
        if (yearSelect) {
          yearSelect.value = currentDate.getFullYear();
        }

        if (window.elementSdk) {
          window.elementSdk.init({
            defaultConfig,
            onConfigChange: async (config) => {
              try {
                const appTitle = document.getElementById('app-title');
                if (appTitle) {
                  appTitle.textContent = config.app_title || defaultConfig.app_title;
                }
                
                const summaryTitle = document.getElementById('summary-title');
                if (summaryTitle) {
                  summaryTitle.textContent = config.summary_title || defaultConfig.summary_title;
                }
                
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
                
                const baseSize = config.font_size || defaultConfig.font_size;
                if (appTitle) {
                  appTitle.style.fontSize = `${baseSize * 1.5}px`;
                }
                if (summaryTitle) {
                  summaryTitle.style.fontSize = `${baseSize * 1.125}px`;
                }
                const netBalance = document.getElementById('net-balance');
                if (netBalance) {
                  netBalance.style.fontSize = `${baseSize * 2}px`;
                }
                
                document.documentElement.style.setProperty('--bg-primary', config.background_color || defaultConfig.background_color);
                document.documentElement.style.setProperty('--bg-card', config.surface_color || defaultConfig.surface_color);
                document.documentElement.style.setProperty('--text-primary', config.text_color || defaultConfig.text_color);
                document.documentElement.style.setProperty('--teal', config.primary_color || defaultConfig.primary_color);
                document.documentElement.style.setProperty('--income', config.accent_color || defaultConfig.accent_color);
              } catch (error) {
                console.error('Error in onConfigChange:', error);
              }
            },
            mapToCapabilities: (config) => ({
              recolorables: [
                {
                  get: () => config.background_color || defaultConfig.background_color,
                  set: (value) => {
                    if (window.elementSdk && window.elementSdk.config) {
                      window.elementSdk.config.background_color = value;
                      window.elementSdk.setConfig({ background_color: value });
                    }
                  }
                },
                {
                  get: () => config.surface_color || defaultConfig.surface_color,
                  set: (value) => {
                    if (window.elementSdk && window.elementSdk.config) {
                      window.elementSdk.config.surface_color = value;
                      window.elementSdk.setConfig({ surface_color: value });
                    }
                  }
                },
                {
                  get: () => config.text_color || defaultConfig.text_color,
                  set: (value) => {
                    if (window.elementSdk && window.elementSdk.config) {
                      window.elementSdk.config.text_color = value;
                      window.elementSdk.setConfig({ text_color: value });
                    }
                  }
                },
                {
                  get: () => config.primary_color || defaultConfig.primary_color,
                  set: (value) => {
                    if (window.elementSdk && window.elementSdk.config) {
                      window.elementSdk.config.primary_color = value;
                      window.elementSdk.setConfig({ primary_color: value });
                    }
                  }
                },
                {
                  get: () => config.accent_color || defaultConfig.accent_color,
                  set: (value) => {
                    if (window.elementSdk && window.elementSdk.config) {
                      window.elementSdk.config.accent_color = value;
                      window.elementSdk.setConfig({ accent_color: value });
                    }
                  }
                }
              ],
              borderables: [],
              fontEditable: {
                get: () => config.font_family || defaultConfig.font_family,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.font_family = value;
                    window.elementSdk.setConfig({ font_family: value });
                  }
                }
              },
              fontSizeable: {
                get: () => config.font_size || defaultConfig.font_size,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.font_size = value;
                    window.elementSdk.setConfig({ font_size: value });
                  }
                }
              }
            }),
            mapToEditPanelValues: (config) => new Map([
              ["app_title", config.app_title || defaultConfig.app_title],
              ["currency_symbol", config.currency_symbol || defaultConfig.currency_symbol],
              ["summary_title", config.summary_title || defaultConfig.summary_title]
            ])
          });
        }
      } catch (error) {
        console.error('Error initializing app:', error);
        showToast('Error saat inisialisasi aplikasi');
      }
    }

    function updateUI() {
      try {
        const config = window.elementSdk?.config || defaultConfig;
        const currency = config.currency_symbol || defaultConfig.currency_symbol;
        
        const income = transactions
          .filter(t => t.type === 'income')
          .reduce((sum, t) => sum + t.amount, 0);
        
        const expense = transactions
          .filter(t => t.type === 'expense')
          .reduce((sum, t) => sum + t.amount, 0);

        const saving = transactions
          .filter(t => t.type === 'saving')
          .reduce((sum, t) => sum + t.amount, 0);

        const investment = transactions
          .filter(t => t.type === 'investment')
          .reduce((sum, t) => sum + t.amount, 0);
        
        const netBalance = income - expense - saving - investment;
        const balancePercentage = income > 0 ? ((netBalance / income) * 100).toFixed(1) : 0;
        
        const totalSpent = expense + saving + investment;

        const netBalanceEl = document.getElementById('net-balance');
        if (netBalanceEl) {
          netBalanceEl.textContent = formatCurrency(netBalance, currency);
        }
        
        const balancePercentageEl = document.getElementById('balance-percentage');
        if (balancePercentageEl) {
          balancePercentageEl.textContent = `${balancePercentage}%`;
        }
        
        const totalIncomeEl = document.getElementById('total-income');
        if (totalIncomeEl) {
          totalIncomeEl.textContent = formatCurrency(income, currency);
        }
        
        const totalExpenseEl = document.getElementById('total-expense');
        if (totalExpenseEl) {
          totalExpenseEl.textContent = formatCurrency(totalSpent, currency);
        }
        
        const totalTransactionsEl = document.getElementById('total-transactions');
        if (totalTransactionsEl) {
          totalTransactionsEl.textContent = formatCurrency(income + expense + saving + investment, currency);
        }

        updateDistributionChart(income, expense, currency);
        renderTransactions(currency);
      } catch (error) {
        console.error('Error updating UI:', error);
      }
    }

    function renderTransactions(currency) {
      try {
        const filtered = transactions.filter(t => {
          if (currentFilter === 'all') return true;
          return t.type === currentFilter;
        });

        const listContainer = document.getElementById('transactions-list');
        const emptyState = document.getElementById('empty-state');

        if (!listContainer || !emptyState) return;

        if (filtered.length === 0) {
          listContainer.innerHTML = '';
          emptyState.style.display = 'block';
          return;
        }

        emptyState.style.display = 'none';
        
        const sortedTransactions = [...filtered].sort((a, b) => 
          new Date(b.created_at) - new Date(a.created_at)
        );

        listContainer.innerHTML = sortedTransactions.map(t => {
          const date = new Date(t.created_at);
          const formattedDate = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
          const formattedTime = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
          let colorClass = 'income-color';
          let sign = '+';
          
          if (t.type === 'expense') {
            colorClass = 'expense-color';
            sign = '-';
          } else if (t.type === 'saving') {
            colorClass = 'saving-color';
            sign = '-';
          } else if (t.type === 'investment') {
            colorClass = 'investment-color';
            sign = '-';
          }

          const icon = getIconForCategory(t.category, t.type);
          const paymentMethod = getPaymentMethodName(t.payment_method);
          
          return `
            <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-secondary);">
              <div class="flex items-center gap-3 flex-1">
                <div class="category-icon" style="background: var(--bg-card);">
                  ${icon}
                </div>
                <div class="flex-1">
                  <div class="font-medium">${t.description || getCategoryName(t.category, t.type)}</div>
                  <div class="text-sm text-secondary">${formattedDate} â€¢ ${formattedTime}</div>
                  <div class="text-xs text-secondary">${getCategoryName(t.category, t.type)} â€¢ ${paymentMethod}</div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <div class="font-semibold ${colorClass}">
                  ${sign}${formatCurrency(t.amount, currency)}
                </div>
                <button class="delete-btn" data-id="${t.__backendId}">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        }).join('');

        listContainer.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const transaction = transactions.find(t => t.__backendId === id);
            if (transaction) {
              await deleteTransaction(transaction);
            }
          });
        });
      } catch (error) {
        console.error('Error rendering transactions:', error);
      }
    }

    function getPaymentMethodName(methodKey) {
      if (defaultPaymentMethods[methodKey]) {
        return `${defaultPaymentMethods[methodKey].icon} ${defaultPaymentMethods[methodKey].name}`;
      }
      if (customPaymentMethods[methodKey]) {
        return `${customPaymentMethods[methodKey].icon} ${customPaymentMethods[methodKey].name}`;
      }
      return methodKey;
    }

    function updateDistributionChart(income, expense, currency) {
      try {
        let displayIncome = income;
        let displayExpense = expense;
        let total = 0;

        if (currentChartFilter === 'income') {
          displayExpense = 0;
          total = displayIncome;
        } else if (currentChartFilter === 'expense') {
          displayIncome = 0;
          total = displayExpense;
        }

        const chartTotal = document.getElementById('chart-total');
        if (chartTotal) {
          chartTotal.textContent = formatCurrency(total, currency);
        }
        
        const chartIncome = document.getElementById('chart-income');
        if (chartIncome) {
          chartIncome.textContent = formatCurrency(displayIncome, currency);
        }
        
        const chartExpense = document.getElementById('chart-expense');
        if (chartExpense) {
          chartExpense.textContent = formatCurrency(displayExpense, currency);
        }
        
        const incomeLegend = document.getElementById('income-legend');
        if (incomeLegend) {
          incomeLegend.style.display = currentChartFilter === 'expense' ? 'none' : 'flex';
        }
        
        const expenseLegend = document.getElementById('expense-legend');
        if (expenseLegend) {
          expenseLegend.style.display = currentChartFilter === 'income' ? 'none' : 'flex';
        }
        
        const incomeArc = document.getElementById('income-arc');
        const expenseArc = document.getElementById('expense-arc');
        const chartIncomePercentage = document.getElementById('chart-income-percentage');
        const chartExpensePercentage = document.getElementById('chart-expense-percentage');
        
        if (total === 0) {
          if (incomeArc) incomeArc.setAttribute('stroke-dasharray', '0 502.65');
          if (expenseArc) expenseArc.setAttribute('stroke-dasharray', '0 502.65');
          if (chartIncomePercentage) chartIncomePercentage.textContent = '0%';
          if (chartExpensePercentage) chartExpensePercentage.textContent = '0%';
          return;
        }

        const incomePercentage = total > 0 ? (displayIncome / total) * 100 : 0;
        const expensePercentage = total > 0 ? (displayExpense / total) * 100 : 0;
        
        if (chartIncomePercentage) {
          chartIncomePercentage.textContent = `${incomePercentage.toFixed(1)}%`;
        }
        if (chartExpensePercentage) {
          chartExpensePercentage.textContent = `${expensePercentage.toFixed(1)}%`;
        }
        
        const circumference = 502.65;
        
        const incomeArcLength = (incomePercentage / 100) * circumference;
        const expenseArcLength = (expensePercentage / 100) * circumference;
        
        if (incomeArc) {
          incomeArc.setAttribute('stroke-dasharray', `${incomeArcLength} ${circumference - incomeArcLength}`);
        }
        
        if (expenseArc) {
          expenseArc.setAttribute('stroke-dasharray', `${expenseArcLength} ${circumference - expenseArcLength}`);
          expenseArc.setAttribute('stroke-dashoffset', `-${incomeArcLength}`);
        }
      } catch (error) {
        console.error('Error updating distribution chart:', error);
      }
    }

    function formatCurrency(amount, currency) {
      return `${currency}${amount.toLocaleString('id-ID')}`;
    }

    function getCategoryName(categoryKey, type) {
      if (type === 'income') {
        if (incomeCategories[categoryKey]) return incomeCategories[categoryKey].name;
        if (customCategories.income[categoryKey]) return customCategories.income[categoryKey].name;
      } else if (type === 'expense') {
        if (expenseCategories[categoryKey]) return expenseCategories[categoryKey].name;
        if (customCategories.expense[categoryKey]) return customCategories.expense[categoryKey].name;
      } else if (type === 'saving') {
        if (savingCategories[categoryKey]) return savingCategories[categoryKey].name;
        if (customCategories.saving[categoryKey]) return customCategories.saving[categoryKey].name;
      } else if (type === 'investment') {
        if (investmentCategories[categoryKey]) return investmentCategories[categoryKey].name;
        if (customCategories.investment[categoryKey]) return customCategories.investment[categoryKey].name;
      }
      return categoryKey;
    }

    function getIconForCategory(categoryKey, type) {
      if (categoryIcons[categoryKey]) return categoryIcons[categoryKey];
      
      if (type === 'income' && customCategories.income[categoryKey]) {
        return customCategories.income[categoryKey].icon;
      } else if (type === 'expense' && customCategories.expense[categoryKey]) {
        return customCategories.expense[categoryKey].icon;
      } else if (type === 'saving' && customCategories.saving[categoryKey]) {
        return customCategories.saving[categoryKey].icon;
      } else if (type === 'investment' && customCategories.investment[categoryKey]) {
        return customCategories.investment[categoryKey].icon;
      }
      
      return 'ğŸ“';
    }

    async function deleteTransaction(transaction) {
      try {
        const result = await window.dataSdk.delete(transaction);
        if (result.isOk) {
          showToast('âœ… Transaksi dihapus');
        } else {
          showToast('âŒ Gagal menghapus transaksi');
        }
      } catch (error) {
        console.error('Error deleting transaction:', error);
        showToast('âŒ Error menghapus transaksi');
      }
    }

    function showToast(message) {
      try {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 2000);
      } catch (error) {
        console.error('Error showing toast:', error);
      }
    }

    const copyScriptBtn = document.getElementById('copy-script-btn');
    if (copyScriptBtn) {
      copyScriptBtn.addEventListener('click', () => {
        const scriptCode = document.getElementById('apps-script-code');
        if (scriptCode) {
          const text = scriptCode.textContent;
          navigator.clipboard.writeText(text).then(() => {
            showToast('ğŸ“‹ Kode berhasil dicopy!');
          }).catch(err => {
            console.error('Error copying:', err);
            showToast('âŒ Gagal copy kode');
          });
        }
      });
    }

    const connectGoogleSheetsBtn = document.getElementById('connect-google-sheets-btn');
    if (connectGoogleSheetsBtn) {
      connectGoogleSheetsBtn.addEventListener('click', () => {
        const modal = document.getElementById('google-sheets-modal');
        if (modal) {
          modal.classList.add('active');
        }
        const urlInput = document.getElementById('google-sheets-url');
        if (googleSheetsUrl && urlInput) {
          urlInput.value = googleSheetsUrl;
        }
      });
    }

    const closeGoogleSheetsModal = document.getElementById('close-google-sheets-modal');
    if (closeGoogleSheetsModal) {
      closeGoogleSheetsModal.addEventListener('click', () => {
        const modal = document.getElementById('google-sheets-modal');
        if (modal) {
          modal.classList.remove('active');
        }
      });
    }

    const testConnectionBtn = document.getElementById('test-connection-btn');
    if (testConnectionBtn) {
      testConnectionBtn.addEventListener('click', async () => {
        const urlInput = document.getElementById('google-sheets-url');
        const resultDiv = document.getElementById('connection-result');
        
        if (!urlInput || !resultDiv) return;
        
        const url = urlInput.value;
        
        if (!url) {
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = '<div style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 12px; border-radius: 8px; text-sm;">âš ï¸ Masukkan URL terlebih dahulu</div>';
          return;
        }

        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-sm;">ğŸ”„ Testing connection...</div>';

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              tanggal: new Date().toLocaleString('id-ID'),
              kode_transaksi: 'TEST-' + Date.now(),
              tipe: 'test',
              kategori: 'Test Connection',
              jumlah: 0,
              keterangan: 'Test connection from Canva Code',
              metode_pembayaran: 'Test'
            })
          });
          
          if (response.ok) {
            const data = await response.json();
            
            if (data.success) {
              resultDiv.innerHTML = '<div style="background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 12px; border-radius: 8px; text-sm;">âœ… Connection successful! Data sent to Google Sheets.</div>';
            } else {
              resultDiv.innerHTML = `<div style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 12px; border-radius: 8px; text-sm;">âŒ Error: ${data.message || 'Unknown error'}</div>`;
            }
          } else {
            resultDiv.innerHTML = `<div style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 12px; border-radius: 8px; text-sm;">âŒ Connection failed: HTTP ${response.status}</div>`;
          }
        } catch (error) {
          console.error('âŒ Test connection error:', error);
          resultDiv.innerHTML = `<div style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 12px; border-radius: 8px; text-sm;">âŒ Connection failed: ${error.message}</div>`;
        }
      });
    }

    const googleSheetsForm = document.getElementById('google-sheets-form');
    if (googleSheetsForm) {
      googleSheetsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const urlInput = document.getElementById('google-sheets-url');
        if (!urlInput) return;
        
        const url = urlInput.value;
        
        if (url) {
          googleSheetsUrl = url;
          localStorage.setItem('googleSheetsUrl', url);
          updateGoogleSheetsStatus(true);
          const modal = document.getElementById('google-sheets-modal');
          if (modal) {
            modal.classList.remove('active');
          }
          showToast('âœ… Google Sheets berhasil terhubung!');
        }
      });
    }

    const googleSheetsModal = document.getElementById('google-sheets-modal');
    if (googleSheetsModal) {
      googleSheetsModal.addEventListener('click', (e) => {
        if (e.target.id === 'google-sheets-modal') {
          googleSheetsModal.classList.remove('active');
        }
      });
    }

    const loadFromSheetsBtn = document.getElementById('load-from-sheets-btn');
    if (loadFromSheetsBtn) {
      loadFromSheetsBtn.addEventListener('click', async () => {
        await loadFromGoogleSheets();
      });
    }

    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode', isDarkMode);
        const themeIcon = document.getElementById('theme-icon');
        if (themeIcon) {
          themeIcon.textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
        }
      });
    }

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.dataset.filter;
        const config = window.elementSdk?.config || defaultConfig;
        renderTransactions(config.currency_symbol || defaultConfig.currency_symbol);
      });
    });

    document.querySelectorAll('.chart-filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.chart-filter-btn').forEach(b => {
          b.classList.remove('active');
          b.style.background = 'var(--bg-secondary)';
          b.style.color = 'var(--text-primary)';
        });
        e.target.classList.add('active');
        e.target.style.background = 'var(--teal)';
        e.target.style.color = 'white';
        currentChartFilter = e.target.dataset.chartFilter;
        updateUI();
      });
    });

    const addTransactionBtn = document.getElementById('add-transaction-btn');
    if (addTransactionBtn) {
      addTransactionBtn.addEventListener('click', () => {
        const modal = document.getElementById('transaction-modal');
        if (modal) {
          modal.classList.add('active');
        }
        
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('transaction-date');
        if (dateInput) {
          dateInput.value = today;
        }
        
        updateCategoryDropdown();
        updatePaymentMethodDropdown();
      });
    }

    function updateCategoryDropdown() {
      try {
        const transactionType = document.getElementById('transaction-type');
        const categorySelect = document.getElementById('transaction-category');
        
        if (!transactionType || !categorySelect) return;
        
        const typeValue = transactionType.value;
        categorySelect.innerHTML = '';
        
        let categories = {};
        if (typeValue === 'income') {
          categories = { ...incomeCategories, ...customCategories.income };
        } else if (typeValue === 'expense') {
          categories = { ...expenseCategories, ...customCategories.expense };
        } else if (typeValue === 'saving') {
          categories = { ...savingCategories, ...customCategories.saving };
        } else if (typeValue === 'investment') {
          categories = { ...investmentCategories, ...customCategories.investment };
        }
        
        Object.keys(categories).forEach(key => {
          const category = categories[key];
          const option = document.createElement('option');
          option.value = key;
          option.textContent = `${category.icon} ${category.name}`;
          option.style.color = 'var(--text-primary)';
          categorySelect.appendChild(option);
        });

        const addNewOption = document.createElement('option');
        addNewOption.value = '__new__';
        addNewOption.textContent = 'â• Buat Kategori Baru';
        addNewOption.style.color = 'var(--teal)';
        addNewOption.style.fontWeight = '600';
        categorySelect.appendChild(addNewOption);
      } catch (error) {
        console.error('Error updating category dropdown:', error);
      }
    }

    function updatePaymentMethodDropdown() {
      try {
        const paymentSelect = document.getElementById('payment-method');
        if (!paymentSelect) return;
        
        paymentSelect.innerHTML = '';
        
        const allMethods = { ...defaultPaymentMethods, ...customPaymentMethods };
        
        Object.keys(allMethods).forEach(key => {
          const method = allMethods[key];
          const option = document.createElement('option');
          option.value = key;
          option.textContent = `${method.icon} ${method.name}`;
          option.style.color = 'var(--text-primary)';
          paymentSelect.appendChild(option);
        });

        const addNewOption = document.createElement('option');
        addNewOption.value = '__new_payment__';
        addNewOption.textContent = 'â• Buat Metode Pembayaran Baru';
        addNewOption.style.color = 'var(--teal)';
        addNewOption.style.fontWeight = '600';
        paymentSelect.appendChild(addNewOption);
      } catch (error) {
        console.error('Error updating payment method dropdown:', error);
      }
    }

    const transactionType = document.getElementById('transaction-type');
    if (transactionType) {
      transactionType.addEventListener('change', updateCategoryDropdown);
    }

    const transactionCategory = document.getElementById('transaction-category');
    if (transactionCategory) {
      transactionCategory.addEventListener('change', (e) => {
        const customForm = document.getElementById('custom-category-form');
        if (customForm) {
          customForm.style.display = e.target.value === '__new__' ? 'block' : 'none';
          const customCategoryName = document.getElementById('custom-category-name');
          if (customCategoryName && e.target.value === '__new__') {
            customCategoryName.value = '';
          }
        }
      });
    }

    const paymentMethod = document.getElementById('payment-method');
    if (paymentMethod) {
      paymentMethod.addEventListener('change', (e) => {
        const customPaymentForm = document.getElementById('custom-payment-form');
        if (customPaymentForm) {
          customPaymentForm.style.display = e.target.value === '__new_payment__' ? 'block' : 'none';
          const customPaymentName = document.getElementById('custom-payment-name');
          if (customPaymentName && e.target.value === '__new_payment__') {
            customPaymentName.value = '';
          }
        }
      });
    }

    const addCustomCategoryBtn = document.getElementById('add-custom-category-btn');
    if (addCustomCategoryBtn) {
      addCustomCategoryBtn.addEventListener('click', () => {
        try {
          const categoryNameInput = document.getElementById('custom-category-name');
          const transactionTypeSelect = document.getElementById('transaction-type');

          if (!categoryNameInput || !transactionTypeSelect) return;

          const categoryName = categoryNameInput.value.trim();
          const transactionTypeValue = transactionTypeSelect.value;

          if (!categoryName) {
            showToast('âš ï¸ Masukkan nama kategori');
            return;
          }

          const categoryKey = categoryName.toLowerCase().replace(/\s+/g, '_');
          
          if (customCategories[transactionTypeValue][categoryKey]) {
            showToast('âš ï¸ Kategori sudah ada');
            return;
          }

          let categoryIcon = 'ğŸ“';
          if (transactionTypeValue === 'income') {
            categoryIcon = 'ğŸ’µ';
          } else if (transactionTypeValue === 'expense') {
            categoryIcon = 'ğŸ’¸';
          } else if (transactionTypeValue === 'saving') {
            categoryIcon = 'ğŸ¦';
          } else if (transactionTypeValue === 'investment') {
            categoryIcon = 'ğŸ’¹';
          }
          
          customCategories[transactionTypeValue][categoryKey] = {
            name: categoryName,
            icon: categoryIcon
          };

          if (!categoryIcons[categoryKey]) {
            categoryIcons[categoryKey] = categoryIcon;
          }

          updateCategoryDropdown();
          
          const categorySelect = document.getElementById('transaction-category');
          if (categorySelect) {
            categorySelect.value = categoryKey;
          }
          
          const customCategoryForm = document.getElementById('custom-category-form');
          if (customCategoryForm) {
            customCategoryForm.style.display = 'none';
          }
          
          categoryNameInput.value = '';
          
          showToast(`âœ… Kategori "${categoryName}" berhasil ditambahkan`);
        } catch (error) {
          console.error('Error adding custom category:', error);
          showToast('âŒ Error menambah kategori');
        }
      });
    }

    const addCustomPaymentBtn = document.getElementById('add-custom-payment-btn');
    if (addCustomPaymentBtn) {
      addCustomPaymentBtn.addEventListener('click', () => {
        try {
          const paymentNameInput = document.getElementById('custom-payment-name');
          if (!paymentNameInput) return;

          const paymentName = paymentNameInput.value.trim();
          const paymentIcon = 'ğŸ’³';

          if (!paymentName) {
            showToast('âš ï¸ Masukkan nama metode pembayaran');
            return;
          }

          const paymentKey = paymentName.toLowerCase().replace(/\s+/g, '_');
          
          customPaymentMethods[paymentKey] = {
            name: paymentName,
            icon: paymentIcon
          };

          updatePaymentMethodDropdown();
          
          const paymentSelect = document.getElementById('payment-method');
          if (paymentSelect) {
            paymentSelect.value = paymentKey;
          }
          
          const customPaymentForm = document.getElementById('custom-payment-form');
          if (customPaymentForm) {
            customPaymentForm.style.display = 'none';
          }
          
          showToast(`âœ… Metode pembayaran "${paymentName}" berhasil ditambahkan`);
        } catch (error) {
          console.error('Error adding custom payment:', error);
          showToast('âŒ Error menambah metode pembayaran');
        }
      });
    }

    const closeModal = document.getElementById('close-modal');
    if (closeModal) {
      closeModal.addEventListener('click', () => {
        const modal = document.getElementById('transaction-modal');
        if (modal) {
          modal.classList.remove('active');
        }
        const form = document.getElementById('transaction-form');
        if (form) {
          form.reset();
        }
        const customCategoryForm = document.getElementById('custom-category-form');
        if (customCategoryForm) {
          customCategoryForm.style.display = 'none';
        }
        const customPaymentForm = document.getElementById('custom-payment-form');
        if (customPaymentForm) {
          customPaymentForm.style.display = 'none';
        }
        isSubmitting = false;
        const submitBtn = document.getElementById('submit-btn');
        if (submitBtn) {
          submitBtn.textContent = 'Simpan Transaksi';
          submitBtn.disabled = false;
        }
      });
    }

    const amountInput = document.getElementById('transaction-amount');
    if (amountInput) {
      amountInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\./g, '');
        
        if (!/^\d*$/.test(value)) {
          value = value.replace(/\D/g, '');
        }
        
        if (value === '') {
          e.target.value = '';
          return;
        }
        
        const formattedValue = parseInt(value).toLocaleString('id-ID');
        e.target.value = formattedValue;
      });

      amountInput.addEventListener('keydown', (e) => {
        const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'];
        if (allowedKeys.includes(e.key) || (e.key >= '0' && e.key <= '9')) {
          return;
        }
        e.preventDefault();
      });
    }

    const transactionForm = document.getElementById('transaction-form');
    if (transactionForm) {
      transactionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (isSubmitting) {
          console.log('âš ï¸ Sudah dalam proses submit, skip');
          return;
        }
        
        if (transactions.length >= 999) {
          showToast('âš ï¸ Maksimum 999 transaksi tercapai. Hapus beberapa transaksi terlebih dahulu.');
          return;
        }

        try {
          const categorySelect = document.getElementById('transaction-category');
          if (!categorySelect) return;
          
          const categoryValue = categorySelect.value;
          if (categoryValue === '__new__') {
            showToast('âš ï¸ Silakan tambahkan kategori baru atau pilih kategori yang ada');
            return;
          }

          const paymentSelect = document.getElementById('payment-method');
          if (!paymentSelect) return;
          
          const paymentValue = paymentSelect.value;
          if (paymentValue === '__new_payment__') {
            showToast('âš ï¸ Silakan tambahkan metode pembayaran baru atau pilih yang ada');
            return;
          }

          const amountInputEl = document.getElementById('transaction-amount');
          if (!amountInputEl) return;
          
          const amountValue = amountInputEl.value.replace(/\./g, '');
          const parsedAmount = parseFloat(amountValue);
          
          if (!parsedAmount || parsedAmount <= 0) {
            showToast('âš ï¸ Masukkan jumlah yang valid');
            return;
          }

          isSubmitting = true;
          const submitBtn = document.getElementById('submit-btn');
          const originalText = submitBtn ? submitBtn.textContent : 'Simpan Transaksi';
          
          if (submitBtn) {
            submitBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
            submitBtn.disabled = true;
          }

          const transactionTypeEl = document.getElementById('transaction-type');
          const transactionDateEl = document.getElementById('transaction-date');
          const transactionDescriptionEl = document.getElementById('transaction-description');
          
          if (!transactionTypeEl || !transactionDateEl) {
            throw new Error('Form elements not found');
          }

          const selectedDate = transactionDateEl.value;
          const transactionDate = selectedDate ? new Date(selectedDate + 'T12:00:00') : new Date();
          
          const newTransaction = {
            id: Date.now().toString(),
            type: transactionTypeEl.value,
            category: categoryValue,
            amount: parsedAmount,
            description: transactionDescriptionEl ? transactionDescriptionEl.value || '' : '',
            payment_method: paymentValue,
            created_at: transactionDate.toISOString()
          };

          console.log('ğŸ“¤ Mengirim transaksi ke Data SDK:', newTransaction);

          const result = await window.dataSdk.create(newTransaction);
          
          console.log('ğŸ“¥ Response dari Data SDK:', result);

          if (result.isOk) {
            console.log('âœ… Transaksi berhasil disimpan ke Data SDK');
            
            if (isGoogleSheetsConnected && googleSheetsUrl) {
              console.log('ğŸ“¤ Mengirim ke Google Sheets...');
              const gsResult = await syncToGoogleSheets(newTransaction);
              
              if (gsResult.success) {
                showToast('âœ… Tersinkronisasi ke Google Sheets');
              } else {
                console.log('âš ï¸ Google Sheets sync failed:', gsResult.message);
                showToast('âš ï¸ Disimpan lokal, gagal sync ke Google Sheets');
              }
            }
            
            const modal = document.getElementById('transaction-modal');
            if (modal) {
              modal.classList.remove('active');
            }
            
            const form = document.getElementById('transaction-form');
            if (form) {
              form.reset();
            }
            
            const customCategoryForm = document.getElementById('custom-category-form');
            if (customCategoryForm) {
              customCategoryForm.style.display = 'none';
            }
            
            const customPaymentForm = document.getElementById('custom-payment-form');
            if (customPaymentForm) {
              customPaymentForm.style.display = 'none';
            }
            
            showToast('âœ… Transaksi berhasil disimpan');
          } else {
            console.error('âŒ Data SDK error:', result.error);
            showToast('âŒ Gagal menyimpan: ' + (result.error?.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('âŒ Exception saat menyimpan:', error);
          showToast('âŒ Error: ' + error.message);
        } finally {
          isSubmitting = false;
          const submitBtn = document.getElementById('submit-btn');
          if (submitBtn) {
            submitBtn.textContent = 'Simpan Transaksi';
            submitBtn.disabled = false;
          }
        }
      });
    }

    const transactionModal = document.getElementById('transaction-modal');
    if (transactionModal) {
      transactionModal.addEventListener('click', (e) => {
        if (e.target.id === 'transaction-modal') {
          transactionModal.classList.remove('active');
          const form = document.getElementById('transaction-form');
          if (form) {
            form.reset();
          }
          const customCategoryForm = document.getElementById('custom-category-form');
          if (customCategoryForm) {
            customCategoryForm.style.display = 'none';
          }
          const customPaymentForm = document.getElementById('custom-payment-form');
          if (customPaymentForm) {
            customPaymentForm.style.display = 'none';
          }
          isSubmitting = false;
          const submitBtn = document.getElementById('submit-btn');
          if (submitBtn) {
            submitBtn.textContent = 'Simpan Transaksi';
            submitBtn.disabled = false;
          }
        }
      });
    }

    const reportBtn = document.getElementById('report-btn');
    if (reportBtn) {
      reportBtn.addEventListener('click', () => {
        const currentDate = new Date();
        const reportMonth = document.getElementById('report-month');
        if (reportMonth) {
          reportMonth.value = currentDate.getMonth();
        }
        
        const reportYear = document.getElementById('report-year');
        if (reportYear) {
          reportYear.innerHTML = '';
          for (let year = 2025; year <= 2040; year++) {
            reportYear.innerHTML += `<option value="${year}">${year}</option>`;
          }
        }
        
        generateReport();
        const modal = document.getElementById('report-modal');
        if (modal) {
          modal.classList.add('active');
        }
      });
    }

    const closeReportModal = document.getElementById('close-report-modal');
    if (closeReportModal) {
      closeReportModal.addEventListener('click', () => {
        const modal = document.getElementById('report-modal');
        if (modal) {
          modal.classList.remove('active');
        }
      });
    }

    const reportMonth = document.getElementById('report-month');
    if (reportMonth) {
      reportMonth.addEventListener('change', generateReport);
    }

    const reportYear = document.getElementById('report-year');
    if (reportYear) {
      reportYear.addEventListener('change', generateReport);
    }

    function generateReport() {
      try {
        const monthSelect = document.getElementById('report-month');
        const yearSelect = document.getElementById('report-year');
        
        if (!monthSelect || !yearSelect) return;
        
        const month = parseInt(monthSelect.value);
        const year = parseInt(yearSelect.value);
        const config = window.elementSdk?.config || defaultConfig;
        const currency = config.currency_symbol || defaultConfig.currency_symbol;

        const monthTransactions = transactions.filter(t => {
          const date = new Date(t.created_at);
          return date.getMonth() === month && date.getFullYear() === year;
        });

        const income = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const expense = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        const saving = monthTransactions.filter(t => t.type === 'saving').reduce((sum, t) => sum + t.amount, 0);
        const investment = monthTransactions.filter(t => t.type === 'investment').reduce((sum, t) => sum + t.amount, 0);
        const balance = income - expense - saving - investment;

        const categoryBreakdown = {};
        monthTransactions.forEach(t => {
          if (!categoryBreakdown[t.category]) {
            categoryBreakdown[t.category] = { income: 0, expense: 0, saving: 0, investment: 0 };
          }
          categoryBreakdown[t.category][t.type] += t.amount;
        });

        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                            'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

        let reportHTML = `
          <div class="app-card p-4 mb-4">
            <h4 class="font-semibold mb-3">Ringkasan ${monthNames[month]} ${year}</h4>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-secondary">Total Pemasukan</span>
                <span class="income-color font-semibold">${formatCurrency(income, currency)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-secondary">Total Pengeluaran</span>
                <span class="expense-color font-semibold">${formatCurrency(expense, currency)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-secondary">Total Tabungan</span>
                <span class="saving-color font-semibold">${formatCurrency(saving, currency)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-secondary">Total Investasi</span>
                <span class="investment-color font-semibold">${formatCurrency(investment, currency)}</span>
              </div>
              <div class="flex justify-between pt-2 border-t" style="border-color: var(--border-color);">
                <span class="font-semibold">Saldo Bersih</span>
                <span class="font-semibold" style="color: ${balance >= 0 ? 'var(--income)' : 'var(--expense)'}">
                  ${formatCurrency(balance, currency)}
                </span>
              </div>
            </div>
          </div>

          <div class="app-card p-4">
            <h4 class="font-semibold mb-3">Breakdown per Kategori</h4>
            <div class="space-y-3">
        `;

        Object.keys(categoryBreakdown).forEach(cat => {
          const catData = categoryBreakdown[cat];
          const transactionType = catData.income > 0 ? 'income' : catData.expense > 0 ? 'expense' : catData.saving > 0 ? 'saving' : 'investment';
          reportHTML += `
            <div class="flex items-center justify-between p-2 rounded" style="background: var(--bg-secondary);">
              <div class="flex items-center gap-2">
                <span class="text-xl">${getIconForCategory(cat, transactionType)}</span>
                <span class="capitalize">${getCategoryName(cat, transactionType)}</span>
              </div>
              <div class="text-right">
                ${catData.income > 0 ? `<div class="text-sm income-color">+${formatCurrency(catData.income, currency)}</div>` : ''}
                ${catData.expense > 0 ? `<div class="text-sm expense-color">-${formatCurrency(catData.expense, currency)}</div>` : ''}
                ${catData.saving > 0 ? `<div class="text-sm saving-color">-${formatCurrency(catData.saving, currency)}</div>` : ''}
                ${catData.investment > 0 ? `<div class="text-sm investment-color">-${formatCurrency(catData.investment, currency)}</div>` : ''}
              </div>
            </div>
          `;
        });

        reportHTML += `
            </div>
          </div>
        `;

        const reportContent = document.getElementById('report-content');
        if (reportContent) {
          reportContent.innerHTML = reportHTML;
        }
      } catch (error) {
        console.error('Error generating report:', error);
      }
    }

    const exportReportBtn = document.getElementById('export-report-btn');
    if (exportReportBtn) {
      exportReportBtn.addEventListener('click', () => {
        try {
          const monthSelect = document.getElementById('report-month');
          const yearSelect = document.getElementById('report-year');
          
          if (!monthSelect || !yearSelect) return;
          
          const month = parseInt(monthSelect.value);
          const year = parseInt(yearSelect.value);
          const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

          const monthTransactions = transactions.filter(t => {
            const date = new Date(t.created_at);
            return date.getMonth() === month && date.getFullYear() === year;
          });

          let csv = 'Tanggal,Kategori,Deskripsi,Tipe,Jumlah,Metode Pembayaran\n';
          monthTransactions.forEach(t => {
            const date = new Date(t.created_at).toLocaleString('id-ID');
            csv += `"${date}","${t.category}","${t.description}","${t.type}","${t.amount}","${t.payment_method}"\n`;
          });

          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `laporan_${monthNames[month]}_${year}.csv`;
          link.click();
          
          showToast('âœ… Laporan berhasil diexport');
        } catch (error) {
          console.error('Error exporting report:', error);
          showToast('âŒ Error export laporan');
        }
      });
    }

    const exportBtn = document.getElementById('export-btn');
    if (exportBtn) {
      exportBtn.addEventListener('click', () => {
        try {
          if (transactions.length === 0) {
            showToast('âš ï¸ Tidak ada data transaksi untuk diekspor');
            return;
          }

          const config = window.elementSdk?.config || defaultConfig;
          const currency = config.currency_symbol || defaultConfig.currency_symbol;

          let csv = 'Tanggal,Waktu,Kode Transaksi,Tipe,Kategori,Jumlah,Keterangan,Metode Pembayaran\n';
          
          const sortedTransactions = [...transactions].sort((a, b) => 
            new Date(b.created_at) - new Date(a.created_at)
          );

          sortedTransactions.forEach(t => {
            const date = new Date(t.created_at);
            const formattedDate = date.toLocaleDateString('id-ID');
            const formattedTime = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const categoryName = getCategoryName(t.category, t.type);
            const paymentMethod = getPaymentMethodName(t.payment_method);
            const typeName = t.type === 'income' ? 'Pemasukan' : 
                             t.type === 'expense' ? 'Pengeluaran' : 
                             t.type === 'saving' ? 'Tabungan' : 'Investasi';
            
            const description = (t.description || '-').replace(/"/g, '""');
            
            csv += `"${formattedDate}","${formattedTime}","${t.id}","${typeName}","${categoryName}","${currency}${t.amount.toLocaleString('id-ID')}","${description}","${paymentMethod}"\n`;
          });

          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          const timestamp = new Date().toISOString().split('T')[0];
          link.download = `ekspor_transaksi_${timestamp}.csv`;
          link.click();
          
          setTimeout(() => URL.revokeObjectURL(link.href), 100);
          
          showToast(`âœ… ${transactions.length} transaksi berhasil diekspor ke CSV`);
        } catch (error) {
          console.error('Error exporting data:', error);
          showToast('âŒ Error saat ekspor data');
        }
      });
    }

    const settingsBtn = document.getElementById('settings-btn');
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        const modal = document.getElementById('settings-modal');
        if (modal) {
          modal.classList.add('active');
        }
        const settingsThemeToggle = document.getElementById('settings-theme-toggle');
        if (settingsThemeToggle) {
          settingsThemeToggle.classList.toggle('active', isDarkMode);
        }
      });
    }

    const closeSettingsModal = document.getElementById('close-settings-modal');
    if (closeSettingsModal) {
      closeSettingsModal.addEventListener('click', () => {
        const modal = document.getElementById('settings-modal');
        if (modal) {
          modal.classList.remove('active');
        }
      });
    }

    const settingsThemeToggle = document.getElementById('settings-theme-toggle');
    if (settingsThemeToggle) {
      settingsThemeToggle.addEventListener('click', () => {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode', isDarkMode);
        const themeIcon = document.getElementById('theme-icon');
        if (themeIcon) {
          themeIcon.textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
        }
        settingsThemeToggle.classList.toggle('active', isDarkMode);
      });
    }

    document.querySelectorAll('.theme-color-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const color = e.target.dataset.color;
        document.querySelectorAll('.theme-color-btn').forEach(b => b.style.border = '2px solid transparent');
        e.target.style.border = '2px solid var(--text-primary)';
        
        document.documentElement.style.setProperty('--teal', color);
        document.documentElement.style.setProperty('--teal-dark', color);
        
        if (window.elementSdk) {
          window.elementSdk.setConfig({ primary_color: color });
        }
        
        showToast('âœ… Tema warna berhasil diubah');
      });
    });

    const backupBtn = document.getElementById('backup-btn');
    if (backupBtn) {
      backupBtn.addEventListener('click', () => {
        try {
          const backupData = {
            version: '1.0',
            date: new Date().toISOString(),
            transactions: transactions,
            config: window.elementSdk?.config || defaultConfig,
            customCategories: customCategories
          };

          const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `backup_keuangan_${new Date().toISOString().split('T')[0]}.json`;
          link.click();
          
          showToast('âœ… Backup berhasil dibuat');
        } catch (error) {
          console.error('Error creating backup:', error);
          showToast('âŒ Error membuat backup');
        }
      });
    }

    const reportModal = document.getElementById('report-modal');
    if (reportModal) {
      reportModal.addEventListener('click', (e) => {
        if (e.target.id === 'report-modal') {
          reportModal.classList.remove('active');
        }
      });
    }

    const settingsModal = document.getElementById('settings-modal');
    if (settingsModal) {
      settingsModal.addEventListener('click', (e) => {
        if (e.target.id === 'settings-modal') {
          settingsModal.classList.remove('active');
        }
      });
    }

    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b4796d151c7b29b',t:'MTc2NjgyNTYyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-card: #ffffff;
      --text-primary: #1a1a1a;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      --teal: #14b8a6;
      --teal-dark: #0d9488;
      --income: #10b981;
      --expense: #ef4444;
      --saving: #3b82f6;
      --investment: #8b5cf6;
    }

    .dark-mode {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border-color: #334155;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      --teal: #2dd4bf;
      --teal-dark: #14b8a6;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      transition: background 0.3s, color 0.3s;
    }

    .summary-card-gradient {
      background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%);
      border-radius: 24px;
      padding: 28px;
      box-shadow: 0 8px 32px rgba(20, 184, 166, 0.25);
      position: relative;
      overflow: hidden;
    }

    .summary-card-gradient::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 200px;
      height: 200px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      filter: blur(60px);
    }

    .wallet-icon {
      font-size: 28px;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.15));
    }

    .savings-badge {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      padding: 6px 12px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .sub-card-income {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .sub-card-income:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      background: rgba(255, 255, 255, 0.35);
    }

    .sub-card-expense {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .sub-card-expense:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      background: rgba(255, 255, 255, 0.35);
    }

    .arrow-icon-income {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      font-weight: bold;
    }

    .arrow-icon-expense {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      font-weight: bold;
    }

    .app-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: var(--shadow);
      transition: all 0.3s;
    }

    .text-secondary {
      color: var(--text-secondary);
    }

    .btn-primary {
      background: var(--teal);
      color: white;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      background: var(--teal-dark);
      transform: translateY(-1px);
    }

    .income-color {
      color: #059669;
    }

    .expense-color {
      color: #dc2626;
    }

    .saving-color {
      color: var(--saving);
    }

    .investment-color {
      color: var(--investment);
    }

    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .filter-btn.active {
      background: var(--teal);
      color: white;
      border-color: var(--teal);
    }

    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--teal);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(20, 184, 166, 0.4);
      cursor: pointer;
      transition: all 0.2s;
      z-index: 100;
    }

    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(20, 184, 166, 0.5);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 16px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 400px;
      max-height: 90%;
      overflow-y: auto;
    }

    input, select, textarea {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 8px;
      padding: 12px;
      width: 100%;
      transition: all 0.2s;
      font-size: 14px;
    }

    select option {
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 10px;
    }

    #transaction-type {
      font-weight: 600;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--teal);
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 24px;
      background: var(--border-color);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: var(--teal);
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.active .toggle-slider {
      transform: translateX(24px);
    }

    .category-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .delete-btn {
      background: var(--expense);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .delete-btn:hover {
      opacity: 0.8;
    }

    .loading-spinner {
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--teal);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .theme-color-btn {
      cursor: pointer;
      transition: all 0.2s;
    }

    .theme-color-btn:hover {
      transform: scale(1.1);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-pulse {
      animation: pulse 2s ease-in-out infinite;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-connected {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }

    .status-disconnected {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: var(--bg-primary);
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 300;
      animation: fadeInOut 2s;
      max-width: 90%;
      text-align: center;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
      10% { opacity: 1; transform: translateX(-50%) translateY(0); }
      90% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app-wrapper" class="h-full w-full overflow-auto">
   <div class="max-w-md mx-auto p-4" style="padding-bottom: 100px;"><!-- Header -->
    <header class="mb-6">
     <div class="flex items-center justify-between mb-4">
      <h1 id="app-title" class="text-2xl font-bold">Catatan Keuangan Pribadi</h1>
      <div class="flex items-center gap-2"><button id="export-btn" class="p-2 rounded-full hover:bg-opacity-10" style="background: var(--bg-secondary);" title="Export Data">ğŸ“¥</button> <button id="theme-toggle" class="p-2 rounded-full hover:bg-opacity-10" style="background: var(--bg-secondary);"> <span id="theme-icon">ğŸŒ™</span> </button> <button id="settings-btn" class="p-2 rounded-full" style="background: var(--bg-secondary);">âš™ï¸</button>
      </div>
     </div><!-- Real-time Info Bar -->
     <div class="flex items-center justify-between mb-4 p-3 rounded-lg" style="background: var(--bg-secondary);">
      <div class="flex items-center gap-3">
       <div class="flex items-center gap-2"><span class="text-lg">ğŸ•</span> <span id="real-time-clock" class="text-sm font-semibold" style="font-variant-numeric: tabular-nums;">00:00:00</span>
       </div>
       <div class="flex items-center gap-2"><span class="text-lg">ğŸ“</span> <span class="text-sm text-secondary">Jakarta, Indonesia</span>
       </div>
      </div>
      <div class="flex items-center gap-2">
       <div class="flex items-center gap-1">
        <div id="status-indicator" class="w-2 h-2 rounded-full status-pulse" style="background: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);"></div><span id="status-text" class="text-xs font-semibold" style="color: #10b981;">Online</span>
       </div>
      </div>
     </div>
     <div class="grid grid-cols-2 gap-2"><select id="month-select" class="w-full"> <option value="0">Januari</option> <option value="1">Februari</option> <option value="2">Maret</option> <option value="3">April</option> <option value="4">Mei</option> <option value="5">Juni</option> <option value="6">Juli</option> <option value="7">Agustus</option> <option value="8">September</option> <option value="9">Oktober</option> <option value="10">November</option> <option value="11">Desember</option> </select> <select id="year-select" class="w-full"></select>
     </div>
    </header><!-- Summary Card -->
    <div class="summary-card-gradient mb-6">
     <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-2">
       <div class="wallet-icon">
        ğŸ‘›
       </div>
       <h2 id="summary-title" class="text-xl font-bold text-white">Keuanganmu</h2>
      </div>
      <div class="savings-badge"><span class="text-xs">ğŸ¦</span> <span class="text-xs font-semibold" id="balance-percentage">0%</span>
      </div>
     </div>
     <div class="mb-1 text-sm text-white" style="opacity: 0.9;">
      Saldo Bersih
     </div>
     <div class="text-5xl font-bold text-white mb-6" id="net-balance">
      Rp0
     </div>
     <div class="grid grid-cols-2 gap-3 mb-4">
      <div class="sub-card-income">
       <div class="flex items-center gap-2 mb-2">
        <div class="arrow-icon-income">
         â†“
        </div><span class="text-sm font-medium" style="color: white;">Pemasukan</span>
       </div>
       <div class="text-xl font-bold income-color" id="total-income" style="color: white;">
        Rp0
       </div>
      </div>
      <div class="sub-card-expense">
       <div class="flex items-center gap-2 mb-2">
        <div class="arrow-icon-expense">
         â†‘
        </div><span class="text-sm font-medium" style="color: white;">Pengeluaran</span>
       </div>
       <div class="text-xl font-bold expense-color" id="total-expense" style="color: white;">
        Rp0
       </div>
      </div>
     </div>
     <div class="grid grid-cols-1 gap-3"><button id="report-btn" class="py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all hover:scale-105" style="background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); color: white; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);"> <span class="text-lg">ğŸ“Š</span> <span>Laporan</span> </button>
     </div>
    </div><!-- Chart -->
    <div class="app-card p-6 mb-6">
     <div class="flex items-center justify-between mb-4">
      <h3 class="font-semibold">Distribusi Keuangan</h3>
      <div class="flex gap-2"><button class="chart-filter-btn active" data-chart-filter="income" style="padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--teal); color: white; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;"> Pemasukan </button> <button class="chart-filter-btn" data-chart-filter="expense" style="padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;"> Pengeluaran </button>
      </div>
     </div>
     <div class="flex flex-col items-center"><!-- Donut Chart -->
      <div class="relative" style="width: 200px; height: 200px; margin-bottom: 20px;">
       <svg id="donut-chart" viewbox="0 0 200 200" style="transform: rotate(-90deg);"><circle cx="100" cy="100" r="80" fill="none" stroke="var(--bg-secondary)" stroke-width="40" /> <circle id="income-arc" cx="100" cy="100" r="80" fill="none" stroke="var(--income)" stroke-width="40" stroke-dasharray="0 502.65" stroke-linecap="round" style="transition: stroke-dasharray 0.5s ease;" /> <circle id="expense-arc" cx="100" cy="100" r="80" fill="none" stroke="var(--expense)" stroke-width="40" stroke-dasharray="0 502.65" stroke-linecap="round" style="transition: stroke-dasharray 0.5s ease;" />
       </svg>
       <div class="absolute inset-0 flex flex-col items-center justify-center">
        <div class="text-xs text-secondary mb-1">
         Total
        </div>
        <div class="text-xl font-bold" id="chart-total">
         Rp0
        </div>
       </div>
      </div><!-- Legend -->
      <div class="w-full space-y-3">
       <div id="income-legend" class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-secondary);">
        <div class="flex items-center gap-2">
         <div style="width: 16px; height: 16px; border-radius: 4px; background: var(--income);"></div><span class="text-sm font-medium">Pemasukan</span>
        </div>
        <div class="flex items-center gap-2"><span class="text-xs font-bold income-color" id="chart-income-percentage">0%</span> <span class="text-sm font-semibold income-color" id="chart-income">Rp0</span>
        </div>
       </div>
       <div id="expense-legend" class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-secondary);">
        <div class="flex items-center gap-2">
         <div style="width: 16px; height: 16px; border-radius: 4px; background: var(--expense);"></div><span class="text-sm font-medium">Pengeluaran</span>
        </div>
        <div class="flex items-center gap-2"><span class="text-xs font-bold expense-color" id="chart-expense-percentage">0%</span> <span class="text-sm font-semibold expense-color" id="chart-expense">Rp0</span>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Transactions -->
    <div class="app-card p-6">
     <div class="flex items-center justify-between mb-4">
      <h3 class="font-semibold">Transaksi</h3>
      <div class="text-sm text-secondary" id="total-transactions">
       Rp0
      </div>
     </div>
     <div class="flex gap-2 mb-4 overflow-x-auto pb-2" style="scrollbar-width: thin;"><button class="filter-btn active" data-filter="all">Semua</button> <button class="filter-btn" data-filter="income">ğŸ’° Pemasukan</button> <button class="filter-btn" data-filter="expense">ğŸ’¸ Pengeluaran</button> <button class="filter-btn" data-filter="saving">ğŸ¦ Tabungan</button> <button class="filter-btn" data-filter="investment">ğŸ“Š Investasi</button>
     </div>
     <div id="transactions-list" class="space-y-3"></div>
     <div id="empty-state" class="text-center py-8 text-secondary" style="display: none;">
      <div class="text-4xl mb-2">
       ğŸ’°
      </div>
      <p>Belum ada transaksi</p>
      <p class="text-sm">Klik tombol + untuk menambah transaksi</p>
     </div>
    </div>
   </div><!-- FAB --> <button class="fab" id="add-transaction-btn">+</button> <!-- Report Modal -->
   <div class="modal-overlay" id="report-modal">
    <div class="modal-content" style="max-width: 500px;">
     <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold">Laporan Bulanan</h3><button id="close-report-modal" class="text-2xl">Ã—</button>
     </div>
     <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Pilih Bulan</label> <select id="report-month" class="w-full"> <option value="0">Januari</option> <option value="1">Februari</option> <option value="2">Maret</option> <option value="3">April</option> <option value="4">Mei</option> <option value="5">Juni</option> <option value="6">Juli</option> <option value="7">Agustus</option> <option value="8">September</option> <option value="9">Oktober</option> <option value="10">November</option> <option value="11">Desember</option> </select>
     </div>
     <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Tahun</label> <select id="report-year" class="w-full"></select>
     </div>
     <div id="report-content" class="space-y-4"></div><button id="export-report-btn" class="btn-primary w-full py-3 rounded-lg font-semibold mt-4"> ğŸ“¥ Export Laporan (CSV) </button>
    </div>
   </div><!-- Settings Modal -->
   <div class="modal-overlay" id="settings-modal">
    <div class="modal-content">
     <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold">Pengaturan</h3><button id="close-settings-modal" class="text-2xl">Ã—</button>
     </div>
     <div class="space-y-4">
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center gap-3 mb-3">
        <div class="text-2xl">
         ğŸ‘¤
        </div>
        <div>
         <div class="font-semibold">
          Profil Pengguna
         </div>
         <div class="text-sm text-secondary">
          Kelola informasi akun
         </div>
        </div>
       </div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-3">
         <div class="text-2xl">
          ğŸ¨
         </div>
         <div>
          <div class="font-semibold">
           Tema Warna
          </div>
          <div class="text-sm text-secondary">
           Pilih warna utama aplikasi
          </div>
         </div>
        </div>
       </div>
       <div class="flex gap-2 mt-3"><button class="theme-color-btn" data-color="#14b8a6" style="background: #14b8a6; width: 40px; height: 40px; border-radius: 8px; border: 2px solid var(--text-primary);"></button> <button class="theme-color-btn" data-color="#3b82f6" style="background: #3b82f6; width: 40px; height: 40px; border-radius: 8px; border: 2px solid transparent;"></button> <button class="theme-color-btn" data-color="#8b5cf6" style="background: #8b5cf6; width: 40px; height: 40px; border-radius: 8px; border: 2px solid transparent;"></button> <button class="theme-color-btn" data-color="#ec4899" style="background: #ec4899; width: 40px; height: 40px; border-radius: 8px; border: 2px solid transparent;"></button> <button class="theme-color-btn" data-color="#f59e0b" style="background: #f59e0b; width: 40px; height: 40px; border-radius: 8px; border: 2px solid transparent;"></button>
       </div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
         <div class="text-2xl">
          ğŸŒ™
         </div>
         <div>
          <div class="font-semibold">
           Mode Gelap
          </div>
          <div class="text-sm text-secondary">
           Toggle tema gelap/terang
          </div>
         </div>
        </div>
        <div class="toggle-switch" id="settings-theme-toggle">
         <div class="toggle-slider"></div>
        </div>
       </div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center gap-3">
        <div class="text-2xl">
         â˜ï¸
        </div>
        <div>
         <div class="font-semibold">
          Sinkronisasi Cloud
         </div>
         <div class="text-sm text-secondary">
          Data tersimpan di Canva Sheet
         </div>
         <div class="text-xs mt-1" style="color: var(--income);">
          âœ… Tersinkronisasi
         </div>
        </div>
       </div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-3">
         <div class="text-2xl">
          ğŸ“Š
         </div>
         <div>
          <div class="font-semibold">
           Google Sheets
          </div>
          <div class="text-sm text-secondary">
           Sinkronisasi ke Google Sheets
          </div>
         </div>
        </div>
        <div id="google-sheets-status-badge" class="status-badge status-connected"><span>ğŸŸ¢</span> <span>Connected</span>
        </div>
       </div><button id="connect-google-sheets-btn" class="btn-primary w-full py-2 rounded-lg font-semibold mb-2"> âš™ï¸ Manage Connection </button> <button id="load-from-sheets-btn" class="w-full py-2 rounded-lg font-semibold" style="background: var(--bg-secondary); color: var(--text-primary);"> ğŸ“¥ Load Data dari Google Sheets </button>
       <div id="google-sheets-info" style="display: none;" class="mt-3 p-3 rounded-lg">
        <div class="text-xs text-secondary mb-2">
         ğŸ“ Instruksi Setup:
        </div>
        <ol class="text-xs text-secondary space-y-1 ml-4" style="list-style: decimal;">
         <li>Buat Google Sheet baru</li>
         <li>Tools â†’ Script Editor</li>
         <li>Paste kode Apps Script</li>
         <li>Deploy â†’ New deployment</li>
         <li>Copy Web App URL</li>
        </ol>
       </div>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center gap-3">
        <div class="text-2xl">
         ğŸ’¾
        </div>
        <div>
         <div class="font-semibold">
          Backup &amp; Restore
         </div>
         <div class="text-sm text-secondary">
          Cadangkan data transaksi
         </div>
        </div>
       </div><button id="backup-btn" class="btn-primary w-full py-2 rounded-lg font-semibold mt-3"> Backup Data </button>
      </div>
      <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
       <div class="flex items-center gap-3">
        <div class="text-2xl">
         ğŸ’±
        </div>
        <div>
         <div class="font-semibold">
          Mata Uang
         </div>
         <div class="text-sm text-secondary">
          Rupiah (IDR)
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Google Sheets Connect Modal -->
   <div class="modal-overlay" id="google-sheets-modal">
    <div class="modal-content">
     <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold">ğŸ“Š Connect Google Sheets</h3><button id="close-google-sheets-modal" class="text-2xl">Ã—</button>
     </div>
     <div class="mb-4 p-4 rounded-lg" style="background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6;">
      <div class="text-sm font-semibold mb-2" style="color: #3b82f6;">
       ğŸ“ Cara Setup Google Sheets
      </div>
      <ol class="text-sm text-secondary space-y-2 ml-4" style="list-style: decimal;">
       <li>Buat <strong>Google Sheet baru</strong></li>
       <li>Klik menu <strong>Extensions â†’ Apps Script</strong></li>
       <li>Hapus kode default, lalu paste kode Apps Script di bawah</li>
       <li>Klik <strong>Deploy â†’ New deployment</strong></li>
       <li>Type: <strong>Web app</strong></li>
       <li>Execute as: <strong>Me</strong></li>
       <li>Who has access: <strong>Anyone</strong></li>
       <li>Klik <strong>Deploy</strong> dan copy <strong>Web App URL</strong></li>
      </ol>
     </div>
     <div class="mb-4 p-4 rounded-lg" style="background: var(--bg-secondary);">
      <div class="flex items-center justify-between mb-2">
       <div class="text-sm font-semibold">
        ğŸ“‹ Kode Google Apps Script
       </div><button id="copy-script-btn" class="text-xs px-3 py-1 rounded" style="background: var(--teal); color: white;"> ğŸ“‹ Copy </button>
      </div>
      <pre id="apps-script-code" class="text-xs p-3 rounded mt-2 overflow-x-auto" style="background: var(--bg-primary); border: 1px solid var(--border-color); max-height: 200px;">function doGet(e) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Transaksi');
    
    if (!sheet) {
      return createJsonResponse({
        success: true,
        data: [],
        count: 0,
        message: 'Sheet Transaksi belum ada'
      });
    }
    
    var lastRow = sheet.getLastRow();
    
    if (lastRow &lt;= 1) {
      return createJsonResponse({
        success: true,
        data: [],
        count: 0,
        message: 'Tidak ada data'
      });
    }
    
    var dataRange = sheet.getRange(2, 1, lastRow - 1, 8);
    var values = dataRange.getValues();
    
    var transactions = [];
    for (var i = 0; i &lt; values.length; i++) {
      if (values[i][1]) {
        transactions.push({
          timestamp: values[i][0],
          kode_transaksi: values[i][1],
          tipe: values[i][2],
          kategori: values[i][3],
          jumlah: values[i][4],
          keterangan: values[i][5],
          metode_pembayaran: values[i][6],
          tanggal: values[i][7]
        });
      }
    }
    
    return createJsonResponse({
      success: true,
      data: transactions,
      count: transactions.length,
      message: 'Data berhasil diambil'
    });
    
  } catch (error) {
    return createJsonResponse({
      success: false,
      error: error.toString(),
      message: 'Gagal mengambil data'
    });
  }
}

function doPost(e) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Transaksi');
    
    if (!sheet) {
      sheet = ss.insertSheet('Transaksi');
      setupHeader(sheet);
    }
    
    if (sheet.getLastRow() === 0) {
      setupHeader(sheet);
    }
    
    var data = JSON.parse(e.postData.contents);
    
    if (data.action === 'delete') {
      return deleteTransaction(sheet, data.kode_transaksi);
    }
    
    var timestamp = new Date();
    var transactionDate = data.tanggal ? new Date(data.tanggal) : timestamp;
    
    sheet.appendRow([
      timestamp,
      data.kode_transaksi || 'TRX-' + Date.now(),
      data.tipe || 'expense',
      data.kategori || 'Lainnya',
      data.jumlah || 0,
      data.keterangan || '',
      data.metode_pembayaran || 'Tunai',
      transactionDate
    ]);
    
    return createJsonResponse({
      success: true,
      message: 'Data berhasil disimpan'
    });
    
  } catch (error) {
    return createJsonResponse({
      success: false,
      error: error.toString(),
      message: 'Gagal menyimpan data'
    });
  }
}

function setupHeader(sheet) {
  sheet.appendRow([
    'Timestamp',
    'Kode Transaksi',
    'Tipe',
    'Kategori',
    'Jumlah',
    'Keterangan',
    'Metode Pembayaran',
    'Tanggal Transaksi'
  ]);
  
  var headerRange = sheet.getRange(1, 1, 1, 8);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#14b8a6');
  headerRange.setFontColor('#ffffff');
  headerRange.setHorizontalAlignment('center');
  sheet.setFrozenRows(1);
  
  sheet.setColumnWidth(1, 150);
  sheet.setColumnWidth(2, 150);
  sheet.setColumnWidth(3, 100);
  sheet.setColumnWidth(4, 150);
  sheet.setColumnWidth(5, 100);
  sheet.setColumnWidth(6, 200);
  sheet.setColumnWidth(7, 150);
  sheet.setColumnWidth(8, 150);
}

function deleteTransaction(sheet, kodeTransaksi) {
  try {
    var lastRow = sheet.getLastRow();
    
    for (var i = 2; i &lt;= lastRow; i++) {
      var rowData = sheet.getRange(i, 2).getValue();
      if (rowData === kodeTransaksi) {
        sheet.deleteRow(i);
        return createJsonResponse({
          success: true,
          message: 'Data berhasil dihapus'
        });
      }
    }
    
    return createJsonResponse({
      success: false,
      error: 'Data tidak ditemukan',
      message: 'Transaksi tidak ditemukan'
    });
  } catch (error) {
    return createJsonResponse({
      success: false,
      error: error.toString(),
      message: 'Gagal menghapus data'
    });
  }
}

function createJsonResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}</pre>
     </div>
     <form id="google-sheets-form">
      <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Google Apps Script URL</label> <input type="url" id="google-sheets-url" placeholder="https://script.google.com/macros/s/.../exec" required>
       <div class="text-xs text-secondary mt-1">
        Paste URL dari Apps Script deployment
       </div>
      </div>
      <div class="flex gap-2"><button type="button" id="test-connection-btn" class="flex-1 py-2 rounded-lg font-semibold" style="background: var(--bg-secondary); color: var(--text-primary);"> ğŸ” Test Connection </button> <button type="submit" class="btn-primary flex-1 py-2 rounded-lg font-semibold"> ğŸ’¾ Save &amp; Connect </button>
      </div>
     </form>
     <div id="connection-result" class="mt-4" style="display: none;"></div>
    </div>
   </div><!-- Transaction Modal -->
   <div class="modal-overlay" id="transaction-modal">
    <div class="modal-content">
     <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold">Tambah Transaksi</h3><button id="close-modal" class="text-2xl">Ã—</button>
     </div>
     <form id="transaction-form">
      <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Tipe</label> <select id="transaction-type" required> <option value="income">ğŸ’° Pemasukan</option> <option value="expense">ğŸ’¸ Pengeluaran</option> <option value="saving">ğŸ¦ Tabungan</option> <option value="investment">ğŸ“Š Investasi</option> </select>
      </div>
      <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Kategori</label> <select id="transaction-category" required> <!-- Categories will be populated dynamically --> </select>
      </div>
      <div id="custom-category-form" style="display: none;" class="mb-4 p-4 rounded-lg"><label class="block text-sm mb-2 text-secondary font-semibold">Buat Kategori Baru</label>
       <div class="mb-3"><label class="block text-xs mb-1 text-secondary">Nama Kategori</label> <input type="text" id="custom-category-name" placeholder="Contoh: Kursus Online">
        <div class="text-xs text-secondary mt-1">
         Ikon akan dipilih otomatis berdasarkan tipe transaksi
        </div>
       </div><button type="button" id="add-custom-category-btn" class="btn-primary w-full py-2 rounded-lg font-semibold text-sm"> â• Tambah Kategori </button>
      </div>
      <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Jumlah</label> <input type="text" id="transaction-amount" placeholder="0" required inputmode="numeric">
      </div>
      <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Tanggal</label> <input type="date" id="transaction-date" required>
      </div>
      <div class="mb-4"><label class="block text-sm mb-2 text-secondary">Deskripsi (opsional)</label> <input type="text" id="transaction-description" placeholder="Deskripsi (opsional)">
      </div>
      <div class="mb-6"><label class="block text-sm mb-2 text-secondary">Metode Pembayaran</label> <select id="payment-method" required> <!-- Payment methods will be populated dynamically --> </select>
      </div>
      <div id="custom-payment-form" style="display: none;" class="mb-6 p-4 rounded-lg"><label class="block text-sm mb-2 text-secondary font-semibold">Buat Metode Pembayaran Baru</label>
       <div class="mb-3"><label class="block text-xs mb-1 text-secondary">Nama Metode Pembayaran</label> <input type="text" id="custom-payment-name" placeholder="Contoh: GoPay, OVO, Dana">
       </div><button type="button" id="add-custom-payment-btn" class="btn-primary w-full py-2 rounded-lg font-semibold text-sm"> â• Tambah Metode Pembayaran </button>
      </div><button type="submit" class="btn-primary w-full py-3 rounded-lg font-semibold" id="submit-btn"> Simpan Transaksi </button>
     </form>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: "Catatan Keuangan Pribadi",
      currency_symbol: "Rp",
      summary_title: "Keuanganmu",
      background_color: "#ffffff",
      surface_color: "#f8f9fa",
      text_color: "#1a1a1a",
      primary_color: "#14b8a6",
      accent_color: "#10b981",
      font_family: "system-ui",
      font_size: 16
    };

    let transactions = [];
    let currentFilter = 'all';
    let currentChartFilter = 'income';
    let isDarkMode = false;
    let isSubmitting = false;
    let isOnline = true;
    let googleSheetsUrl = localStorage.getItem('googleSheetsUrl') || 'https://script.google.com/macros/s/AKfycbyjbuqJRs3uv7ICrdxxmjSxz_yEjs0QsHBwWrRzBa1txkmm24j7tIpTyoGc2ZFj_iG41g/exec';
    let isGoogleSheetsConnected = true;

    function updateClock() {
      try {
        const clockElement = document.getElementById('real-time-clock');
        if (clockElement) {
          const now = new Date();
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const seconds = String(now.getSeconds()).padStart(2, '0');
          clockElement.textContent = `${hours}:${minutes}:${seconds}`;
        }
      } catch (error) {
        console.error('Error updating clock:', error);
      }
    }

    setInterval(updateClock, 1000);
    updateClock();

    function updateOnlineStatus() {
      try {
        const indicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        
        if (!indicator || !statusText) return;
        
        const isConnected = isGoogleSheetsConnected && googleSheetsUrl;
        
        if (isConnected) {
          indicator.style.background = 'var(--income)';
          indicator.style.boxShadow = '0 0 8px rgba(16, 185, 129, 0.5)';
          indicator.classList.add('status-pulse');
          statusText.textContent = 'Online';
          statusText.style.color = 'var(--income)';
          isOnline = true;
        } else {
          indicator.style.background = 'var(--expense)';
          indicator.style.boxShadow = '0 0 8px rgba(239, 68, 68, 0.5)';
          indicator.classList.remove('status-pulse');
          statusText.textContent = 'Offline';
          statusText.style.color = 'var(--expense)';
          isOnline = false;
        }
      } catch (error) {
        console.error('Error updating online status:', error);
      }
    }

    function updateGoogleSheetsStatus(connected) {
      try {
        isGoogleSheetsConnected = connected;
        const statusBadge = document.getElementById('google-sheets-status-badge');
        const connectBtn = document.getElementById('connect-google-sheets-btn');
        
        if (statusBadge) {
          if (connected) {
            statusBadge.className = 'status-badge status-connected';
            statusBadge.innerHTML = '<span>ğŸŸ¢</span><span>Connected</span>';
          } else {
            statusBadge.className = 'status-badge status-disconnected';
            statusBadge.innerHTML = '<span>âš«</span><span>Not Connected</span>';
          }
        }
        
        if (connectBtn) {
          connectBtn.textContent = connected ? 'âš™ï¸ Manage Connection' : 'ğŸ”— Connect to Google Sheets';
        }
        
        updateOnlineStatus();
      } catch (error) {
        console.error('Error updating Google Sheets status:', error);
      }
    }

    async function syncToGoogleSheets(transaction) {
      if (!isGoogleSheetsConnected || !googleSheetsUrl) {
        console.log('âš ï¸ Google Sheets belum terkoneksi, skip sync');
        return { success: false, message: 'Not connected' };
      }

      try {
        console.log('ğŸ“¤ Mengirim ke Google Sheets:', googleSheetsUrl);

        const payload = {
          tanggal: new Date(transaction.created_at).toLocaleString('id-ID'),
          kode_transaksi: transaction.id,
          tipe: transaction.type,
          kategori: getCategoryName(transaction.category, transaction.type),
          jumlah: transaction.amount,
          keterangan: transaction.description || '-',
          metode_pembayaran: getPaymentMethodName(transaction.payment_method)
        };

        const response = await fetch(googleSheetsUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.success) {
            return { success: true, message: 'Sync berhasil' };
          } else {
            console.error('âŒ Google Sheets error:', data.error || data.message);
            return { success: false, message: data.message || 'Gagal sync' };
          }
        } else {
          console.error('âŒ HTTP error:', response.status);
          return { success: false, message: `HTTP error ${response.status}` };
        }
      } catch (error) {
        console.error('âŒ Error sync ke Google Sheets:', error);
        return { success: false, message: error.message };
      }
    }

    async function loadFromGoogleSheets() {
      if (!isGoogleSheetsConnected || !googleSheetsUrl) {
        showToast('âš ï¸ Google Sheets belum terkoneksi');
        return;
      }

      try {
        showToast('ğŸ”„ Memuat data dari Google Sheets...');
        
        const response = await fetch(googleSheetsUrl, {
          method: 'GET'
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success && result.data) {
            console.log('ğŸ“¥ Data dari Google Sheets:', result.data);
            
            for (const row of result.data) {
              const exists = transactions.find(t => t.id === row.kode_transaksi);
              
              if (!exists && row.kode_transaksi && row.jumlah) {
                let parsedDate = new Date();
                try {
                  if (row.tanggal) {
                    const dateStr = row.tanggal.toString();
                    parsedDate = new Date(dateStr);
                    if (isNaN(parsedDate.getTime())) {
                      parsedDate = new Date();
                    }
                  }
                } catch (e) {
                  parsedDate = new Date();
                }
                
                let categoryKey = row.kategori;
                const allCategories = {
                  ...incomeCategories,
                  ...expenseCategories,
                  ...savingCategories,
                  ...investmentCategories,
                  ...customCategories.income,
                  ...customCategories.expense,
                  ...customCategories.saving,
                  ...customCategories.investment
                };
                
                for (const [key, value] of Object.entries(allCategories)) {
                  if (value.name === row.kategori) {
                    categoryKey = key;
                    break;
                  }
                }
                
                let paymentKey = row.metode_pembayaran;
                const allPayments = { ...defaultPaymentMethods, ...customPaymentMethods };
                for (const [key, value] of Object.entries(allPayments)) {
                  if (`${value.icon} ${value.name}` === row.metode_pembayaran) {
                    paymentKey = key;
                    break;
                  }
                }
                
                const newTransaction = {
                  id: row.kode_transaksi,
                  type: row.tipe,
                  category: categoryKey,
                  amount: parseFloat(row.jumlah) || 0,
                  description: row.keterangan === '-' ? '' : row.keterangan,
                  payment_method: paymentKey,
                  created_at: parsedDate.toISOString()
                };
                
                const createResult = await window.dataSdk.create(newTransaction);
                if (!createResult.isOk) {
                  console.error('âŒ Gagal menyimpan data:', row.kode_transaksi);
                }
              }
            }
            
            showToast(`âœ… Berhasil memuat ${result.count} transaksi dari Google Sheets`);
          } else {
            showToast('âš ï¸ Tidak ada data di Google Sheets');
          }
        } else {
          showToast('âŒ Gagal mengambil data dari Google Sheets');
        }
      } catch (error) {
        console.error('âŒ Error load dari Google Sheets:', error);
        showToast('âŒ Error: ' + error.message);
      }
    }

    const incomeCategories = {
      salary: { name: 'Gaji & Pekerjaan', icon: 'ğŸ’°' },
      bonus: { name: 'Bonus', icon: 'ğŸ' },
      business: { name: 'Usaha', icon: 'ğŸ’¼' },
      freelance: { name: 'Freelance', icon: 'ğŸ’»' },
      other_income: { name: 'Lainnya', icon: 'ğŸ’µ' }
    };

    const expenseCategories = {
      household: { name: 'Rumah Tangga', icon: 'ğŸ ' },
      food: { name: 'Makanan & Minuman', icon: 'ğŸ”' },
      transport: { name: 'Transportasi', icon: 'ğŸš—' },
      bills: { name: 'Tagihan', icon: 'ğŸ“„' },
      entertainment: { name: 'Hiburan', icon: 'ğŸ®' },
      health: { name: 'Kesehatan', icon: 'ğŸ¥' },
      shopping: { name: 'Belanja', icon: 'ğŸ›ï¸' },
      other_expense: { name: 'Lainnya', icon: 'ğŸ“' }
    };

    const savingCategories = {
      emergency_fund: { name: 'Dana Darurat', icon: 'ğŸ†˜' },
      education_fund: { name: 'Dana Pendidikan', icon: 'ğŸ“' },
      vacation_fund: { name: 'Dana Liburan', icon: 'âœˆï¸' },
      house_fund: { name: 'Dana Rumah', icon: 'ğŸ¡' },
      wedding_fund: { name: 'Dana Pernikahan', icon: 'ğŸ’’' },
      retirement_fund: { name: 'Dana Pensiun', icon: 'ğŸ‘´' },
      other_saving: { name: 'Lainnya', icon: 'ğŸ¦' }
    };

    const investmentCategories = {
      stocks: { name: 'Saham', icon: 'ğŸ“ˆ' },
      mutual_funds: { name: 'Reksa Dana', icon: 'ğŸ“Š' },
      crypto: { name: 'Cryptocurrency', icon: 'ğŸ’' },
      gold: { name: 'Emas', icon: 'ğŸ¥‡' },
      property: { name: 'Properti', icon: 'ğŸ¢' },
      bonds: { name: 'Obligasi', icon: 'ğŸ“œ' },
      other_investment: { name: 'Lainnya', icon: 'ğŸ’¹' }
    };

    const customCategories = {
      income: {},
      expense: {},
      saving: {},
      investment: {}
    };

    const defaultPaymentMethods = {
      cash: { name: 'Tunai', icon: 'ğŸ’µ' },
      bank_transfer: { name: 'Transfer Bank', icon: 'ğŸ¦' },
      ewallet: { name: 'E-Wallet', icon: 'ğŸ“±' },
      debit: { name: 'Kartu Debit', icon: 'ğŸ’³' },
      credit: { name: 'Kartu Kredit', icon: 'ğŸ’³' }
    };

    const customPaymentMethods = {};

    const categoryIcons = {
      salary: 'ğŸ’°',
      bonus: 'ğŸ',
      business: 'ğŸ’¼',
      freelance: 'ğŸ’»',
      other_income: 'ğŸ’µ',
      household: 'ğŸ ',
      food: 'ğŸ”',
      transport: 'ğŸš—',
      bills: 'ğŸ“„',
      entertainment: 'ğŸ®',
      health: 'ğŸ¥',
      shopping: 'ğŸ›ï¸',
      other_expense: 'ğŸ“',
      emergency_fund: 'ğŸ†˜',
      education_fund: 'ğŸ“',
      vacation_fund: 'âœˆï¸',
      house_fund: 'ğŸ¡',
      wedding_fund: 'ğŸ’’',
      retirement_fund: 'ğŸ‘´',
      other_saving: 'ğŸ¦',
      stocks: 'ğŸ“ˆ',
      mutual_funds: 'ğŸ“Š',
      crypto: 'ğŸ’',
      gold: 'ğŸ¥‡',
      property: 'ğŸ¢',
      bonds: 'ğŸ“œ',
      other_investment: 'ğŸ’¹'
    };

    const dataHandler = {
      onDataChanged(data) {
        transactions = data;
        updateUI();
      }
    };

    async function initApp() {
      try {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          showToast('Gagal menginisialisasi aplikasi');
        }

        if (googleSheetsUrl) {
          updateGoogleSheetsStatus(true);
        } else {
          updateOnlineStatus();
        }

        const currentDate = new Date();
        const yearSelect = document.getElementById('year-select');
        if (yearSelect) {
          for (let year = 2025; year <= 2040; year++) {
            yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
          }
        }
        
        const monthSelect = document.getElementById('month-select');
        if (monthSelect) {
          monthSelect.value = currentDate.getMonth();
        }
        
        if (yearSelect) {
          yearSelect.value = currentDate.getFullYear();
        }

        if (window.elementSdk) {
          window.elementSdk.init({
            defaultConfig,
            onConfigChange: async (config) => {
              try {
                const appTitle = document.getElementById('app-title');
                if (appTitle) {
                  appTitle.textContent = config.app_title || defaultConfig.app_title;
                }
                
                const summaryTitle = document.getElementById('summary-title');
                if (summaryTitle) {
                  summaryTitle.textContent = config.summary_title || defaultConfig.summary_title;
                }
                
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
                
                const baseSize = config.font_size || defaultConfig.font_size;
                if (appTitle) {
                  appTitle.style.fontSize = `${baseSize * 1.5}px`;
                }
                if (summaryTitle) {
                  summaryTitle.style.fontSize = `${baseSize * 1.125}px`;
                }
                const netBalance = document.getElementById('net-balance');
                if (netBalance) {
                  netBalance.style.fontSize = `${baseSize * 2}px`;
                }
                
                document.documentElement.style.setProperty('--bg-primary', config.background_color || defaultConfig.background_color);
                document.documentElement.style.setProperty('--bg-card', config.surface_color || defaultConfig.surface_color);
                document.documentElement.style.setProperty('--text-primary', config.text_color || defaultConfig.text_color);
                document.documentElement.style.setProperty('--teal', config.primary_color || defaultConfig.primary_color);
                document.documentElement.style.setProperty('--income', config.accent_color || defaultConfig.accent_color);
              } catch (error) {
                console.error('Error in onConfigChange:', error);
              }
            },
            mapToCapabilities: (config) => ({
              recolorables: [
                {
                  get: () => config.background_color || defaultConfig.background_color,
                  set: (value) => {
                    if (window.elementSdk && window.elementSdk.config) {
                      window.elementSdk.config.background_color = value;
                      window.elementSdk.setConfig({ background_color: value });
                    }
                  }
                },
                {
                  get: () => config.surface_color || defaultConfig.surface_color,
                  set: (value) => {
                    if (window.elementSdk && window.elementSdk.config) {
                      window.elementSdk.config.surface_color = value;
                      window.elementSdk.setConfig({ surface_color: value });
                    }
                  }
                },
                {
                  get: () => config.text_color || defaultConfig.text_color,
                  set: (value) => {
                    if (window.elementSdk && window.elementSdk.config) {
                      window.elementSdk.config.text_color = value;
                      window.elementSdk.setConfig({ text_color: value });
                    }
                  }
                },
                {
                  get: () => config.primary_color || defaultConfig.primary_color,
                  set: (value) => {
                    if (window.elementSdk && window.elementSdk.config) {
                      window.elementSdk.config.primary_color = value;
                      window.elementSdk.setConfig({ primary_color: value });
                    }
                  }
                },
                {
                  get: () => config.accent_color || defaultConfig.accent_color,
                  set: (value) => {
                    if (window.elementSdk && window.elementSdk.config) {
                      window.elementSdk.config.accent_color = value;
                      window.elementSdk.setConfig({ accent_color: value });
                    }
                  }
                }
              ],
              borderables: [],
              fontEditable: {
                get: () => config.font_family || defaultConfig.font_family,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.font_family = value;
                    window.elementSdk.setConfig({ font_family: value });
                  }
                }
              },
              fontSizeable: {
                get: () => config.font_size || defaultConfig.font_size,
                set: (value) => {
                  if (window.elementSdk && window.elementSdk.config) {
                    window.elementSdk.config.font_size = value;
                    window.elementSdk.setConfig({ font_size: value });
                  }
                }
              }
            }),
            mapToEditPanelValues: (config) => new Map([
              ["app_title", config.app_title || defaultConfig.app_title],
              ["currency_symbol", config.currency_symbol || defaultConfig.currency_symbol],
              ["summary_title", config.summary_title || defaultConfig.summary_title]
            ])
          });
        }
      } catch (error) {
        console.error('Error initializing app:', error);
        showToast('Error saat inisialisasi aplikasi');
      }
    }

    function updateUI() {
      try {
        const config = window.elementSdk?.config || defaultConfig;
        const currency = config.currency_symbol || defaultConfig.currency_symbol;
        
        const income = transactions
          .filter(t => t.type === 'income')
          .reduce((sum, t) => sum + t.amount, 0);
        
        const expense = transactions
          .filter(t => t.type === 'expense')
          .reduce((sum, t) => sum + t.amount, 0);

        const saving = transactions
          .filter(t => t.type === 'saving')
          .reduce((sum, t) => sum + t.amount, 0);

        const investment = transactions
          .filter(t => t.type === 'investment')
          .reduce((sum, t) => sum + t.amount, 0);
        
        const netBalance = income - expense - saving - investment;
        const balancePercentage = income > 0 ? ((netBalance / income) * 100).toFixed(1) : 0;
        
        const totalSpent = expense + saving + investment;

        const netBalanceEl = document.getElementById('net-balance');
        if (netBalanceEl) {
          netBalanceEl.textContent = formatCurrency(netBalance, currency);
        }
        
        const balancePercentageEl = document.getElementById('balance-percentage');
        if (balancePercentageEl) {
          balancePercentageEl.textContent = `${balancePercentage}%`;
        }
        
        const totalIncomeEl = document.getElementById('total-income');
        if (totalIncomeEl) {
          totalIncomeEl.textContent = formatCurrency(income, currency);
        }
        
        const totalExpenseEl = document.getElementById('total-expense');
        if (totalExpenseEl) {
          totalExpenseEl.textContent = formatCurrency(totalSpent, currency);
        }
        
        const totalTransactionsEl = document.getElementById('total-transactions');
        if (totalTransactionsEl) {
          totalTransactionsEl.textContent = formatCurrency(income + expense + saving + investment, currency);
        }

        updateDistributionChart(income, expense, currency);
        renderTransactions(currency);
      } catch (error) {
        console.error('Error updating UI:', error);
      }
    }

    function renderTransactions(currency) {
      try {
        const filtered = transactions.filter(t => {
          if (currentFilter === 'all') return true;
          return t.type === currentFilter;
        });

        const listContainer = document.getElementById('transactions-list');
        const emptyState = document.getElementById('empty-state');

        if (!listContainer || !emptyState) return;

        if (filtered.length === 0) {
          listContainer.innerHTML = '';
          emptyState.style.display = 'block';
          return;
        }

        emptyState.style.display = 'none';
        
        const sortedTransactions = [...filtered].sort((a, b) => 
          new Date(b.created_at) - new Date(a.created_at)
        );

        listContainer.innerHTML = sortedTransactions.map(t => {
          const date = new Date(t.created_at);
          const formattedDate = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
          const formattedTime = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
          let colorClass = 'income-color';
          let sign = '+';
          
          if (t.type === 'expense') {
            colorClass = 'expense-color';
            sign = '-';
          } else if (t.type === 'saving') {
            colorClass = 'saving-color';
            sign = '-';
          } else if (t.type === 'investment') {
            colorClass = 'investment-color';
            sign = '-';
          }

          const icon = getIconForCategory(t.category, t.type);
          const paymentMethod = getPaymentMethodName(t.payment_method);
          
          return `
            <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-secondary);">
              <div class="flex items-center gap-3 flex-1">
                <div class="category-icon" style="background: var(--bg-card);">
                  ${icon}
                </div>
                <div class="flex-1">
                  <div class="font-medium">${t.description || getCategoryName(t.category, t.type)}</div>
                  <div class="text-sm text-secondary">${formattedDate} â€¢ ${formattedTime}</div>
                  <div class="text-xs text-secondary">${getCategoryName(t.category, t.type)} â€¢ ${paymentMethod}</div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <div class="font-semibold ${colorClass}">
                  ${sign}${formatCurrency(t.amount, currency)}
                </div>
                <button class="delete-btn" data-id="${t.__backendId}">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        }).join('');

        listContainer.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const transaction = transactions.find(t => t.__backendId === id);
            if (transaction) {
              await deleteTransaction(transaction);
            }
          });
        });
      } catch (error) {
        console.error('Error rendering transactions:', error);
      }
    }

    function getPaymentMethodName(methodKey) {
      if (defaultPaymentMethods[methodKey]) {
        return `${defaultPaymentMethods[methodKey].icon} ${defaultPaymentMethods[methodKey].name}`;
      }
      if (customPaymentMethods[methodKey]) {
        return `${customPaymentMethods[methodKey].icon} ${customPaymentMethods[methodKey].name}`;
      }
      return methodKey;
    }

    function updateDistributionChart(income, expense, currency) {
      try {
        let displayIncome = income;
        let displayExpense = expense;
        let total = 0;

        if (currentChartFilter === 'income') {
          displayExpense = 0;
          total = displayIncome;
        } else if (currentChartFilter === 'expense') {
          displayIncome = 0;
          total = displayExpense;
        }

        const chartTotal = document.getElementById('chart-total');
        if (chartTotal) {
          chartTotal.textContent = formatCurrency(total, currency);
        }
        
        const chartIncome = document.getElementById('chart-income');
        if (chartIncome) {
          chartIncome.textContent = formatCurrency(displayIncome, currency);
        }
        
        const chartExpense = document.getElementById('chart-expense');
        if (chartExpense) {
          chartExpense.textContent = formatCurrency(displayExpense, currency);
        }
        
        const incomeLegend = document.getElementById('income-legend');
        if (incomeLegend) {
          incomeLegend.style.display = currentChartFilter === 'expense' ? 'none' : 'flex';
        }
        
        const expenseLegend = document.getElementById('expense-legend');
        if (expenseLegend) {
          expenseLegend.style.display = currentChartFilter === 'income' ? 'none' : 'flex';
        }
        
        const incomeArc = document.getElementById('income-arc');
        const expenseArc = document.getElementById('expense-arc');
        const chartIncomePercentage = document.getElementById('chart-income-percentage');
        const chartExpensePercentage = document.getElementById('chart-expense-percentage');
        
        if (total === 0) {
          if (incomeArc) incomeArc.setAttribute('stroke-dasharray', '0 502.65');
          if (expenseArc) expenseArc.setAttribute('stroke-dasharray', '0 502.65');
          if (chartIncomePercentage) chartIncomePercentage.textContent = '0%';
          if (chartExpensePercentage) chartExpensePercentage.textContent = '0%';
          return;
        }

        const incomePercentage = total > 0 ? (displayIncome / total) * 100 : 0;
        const expensePercentage = total > 0 ? (displayExpense / total) * 100 : 0;
        
        if (chartIncomePercentage) {
          chartIncomePercentage.textContent = `${incomePercentage.toFixed(1)}%`;
        }
        if (chartExpensePercentage) {
          chartExpensePercentage.textContent = `${expensePercentage.toFixed(1)}%`;
        }
        
        const circumference = 502.65;
        
        const incomeArcLength = (incomePercentage / 100) * circumference;
        const expenseArcLength = (expensePercentage / 100) * circumference;
        
        if (incomeArc) {
          incomeArc.setAttribute('stroke-dasharray', `${incomeArcLength} ${circumference - incomeArcLength}`);
        }
        
        if (expenseArc) {
          expenseArc.setAttribute('stroke-dasharray', `${expenseArcLength} ${circumference - expenseArcLength}`);
          expenseArc.setAttribute('stroke-dashoffset', `-${incomeArcLength}`);
        }
      } catch (error) {
        console.error('Error updating distribution chart:', error);
      }
    }

    function formatCurrency(amount, currency) {
      return `${currency}${amount.toLocaleString('id-ID')}`;
    }

    function getCategoryName(categoryKey, type) {
      if (type === 'income') {
        if (incomeCategories[categoryKey]) return incomeCategories[categoryKey].name;
        if (customCategories.income[categoryKey]) return customCategories.income[categoryKey].name;
      } else if (type === 'expense') {
        if (expenseCategories[categoryKey]) return expenseCategories[categoryKey].name;
        if (customCategories.expense[categoryKey]) return customCategories.expense[categoryKey].name;
      } else if (type === 'saving') {
        if (savingCategories[categoryKey]) return savingCategories[categoryKey].name;
        if (customCategories.saving[categoryKey]) return customCategories.saving[categoryKey].name;
      } else if (type === 'investment') {
        if (investmentCategories[categoryKey]) return investmentCategories[categoryKey].name;
        if (customCategories.investment[categoryKey]) return customCategories.investment[categoryKey].name;
      }
      return categoryKey;
    }

    function getIconForCategory(categoryKey, type) {
      if (categoryIcons[categoryKey]) return categoryIcons[categoryKey];
      
      if (type === 'income' && customCategories.income[categoryKey]) {
        return customCategories.income[categoryKey].icon;
      } else if (type === 'expense' && customCategories.expense[categoryKey]) {
        return customCategories.expense[categoryKey].icon;
      } else if (type === 'saving' && customCategories.saving[categoryKey]) {
        return customCategories.saving[categoryKey].icon;
      } else if (type === 'investment' && customCategories.investment[categoryKey]) {
        return customCategories.investment[categoryKey].icon;
      }
      
      return 'ğŸ“';
    }

    async function deleteTransaction(transaction) {
      try {
        const result = await window.dataSdk.delete(transaction);
        if (result.isOk) {
          showToast('âœ… Transaksi dihapus');
        } else {
          showToast('âŒ Gagal menghapus transaksi');
        }
      } catch (error) {
        console.error('Error deleting transaction:', error);
        showToast('âŒ Error menghapus transaksi');
      }
    }

    function showToast(message) {
      try {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 2000);
      } catch (error) {
        console.error('Error showing toast:', error);
      }
    }

    const copyScriptBtn = document.getElementById('copy-script-btn');
    if (copyScriptBtn) {
      copyScriptBtn.addEventListener('click', () => {
        const scriptCode = document.getElementById('apps-script-code');
        if (scriptCode) {
          const text = scriptCode.textContent;
          navigator.clipboard.writeText(text).then(() => {
            showToast('ğŸ“‹ Kode berhasil dicopy!');
          }).catch(err => {
            console.error('Error copying:', err);
            showToast('âŒ Gagal copy kode');
          });
        }
      });
    }

    const connectGoogleSheetsBtn = document.getElementById('connect-google-sheets-btn');
    if (connectGoogleSheetsBtn) {
      connectGoogleSheetsBtn.addEventListener('click', () => {
        const modal = document.getElementById('google-sheets-modal');
        if (modal) {
          modal.classList.add('active');
        }
        const urlInput = document.getElementById('google-sheets-url');
        if (googleSheetsUrl && urlInput) {
          urlInput.value = googleSheetsUrl;
        }
      });
    }

    const closeGoogleSheetsModal = document.getElementById('close-google-sheets-modal');
    if (closeGoogleSheetsModal) {
      closeGoogleSheetsModal.addEventListener('click', () => {
        const modal = document.getElementById('google-sheets-modal');
        if (modal) {
          modal.classList.remove('active');
        }
      });
    }

    const testConnectionBtn = document.getElementById('test-connection-btn');
    if (testConnectionBtn) {
      testConnectionBtn.addEventListener('click', async () => {
        const urlInput = document.getElementById('google-sheets-url');
        const resultDiv = document.getElementById('connection-result');
        
        if (!urlInput || !resultDiv) return;
        
        const url = urlInput.value;
        
        if (!url) {
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = '<div style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 12px; border-radius: 8px; text-sm;">âš ï¸ Masukkan URL terlebih dahulu</div>';
          return;
        }

        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-sm;">ğŸ”„ Testing connection...</div>';

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              tanggal: new Date().toLocaleString('id-ID'),
              kode_transaksi: 'TEST-' + Date.now(),
              tipe: 'test',
              kategori: 'Test Connection',
              jumlah: 0,
              keterangan: 'Test connection from Canva Code',
              metode_pembayaran: 'Test'
            })
          });
          
          if (response.ok) {
            const data = await response.json();
            
            if (data.success) {
              resultDiv.innerHTML = '<div style="background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 12px; border-radius: 8px; text-sm;">âœ… Connection successful! Data sent to Google Sheets.</div>';
            } else {
              resultDiv.innerHTML = `<div style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 12px; border-radius: 8px; text-sm;">âŒ Error: ${data.message || 'Unknown error'}</div>`;
            }
          } else {
            resultDiv.innerHTML = `<div style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 12px; border-radius: 8px; text-sm;">âŒ Connection failed: HTTP ${response.status}</div>`;
          }
        } catch (error) {
          console.error('âŒ Test connection error:', error);
          resultDiv.innerHTML = `<div style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 12px; border-radius: 8px; text-sm;">âŒ Connection failed: ${error.message}</div>`;
        }
      });
    }

    const googleSheetsForm = document.getElementById('google-sheets-form');
    if (googleSheetsForm) {
      googleSheetsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const urlInput = document.getElementById('google-sheets-url');
        if (!urlInput) return;
        
        const url = urlInput.value;
        
        if (url) {
          googleSheetsUrl = url;
          localStorage.setItem('googleSheetsUrl', url);
          updateGoogleSheetsStatus(true);
          const modal = document.getElementById('google-sheets-modal');
          if (modal) {
            modal.classList.remove('active');
          }
          showToast('âœ… Google Sheets berhasil terhubung!');
        }
      });
    }

    const googleSheetsModal = document.getElementById('google-sheets-modal');
    if (googleSheetsModal) {
      googleSheetsModal.addEventListener('click', (e) => {
        if (e.target.id === 'google-sheets-modal') {
          googleSheetsModal.classList.remove('active');
        }
      });
    }

    const loadFromSheetsBtn = document.getElementById('load-from-sheets-btn');
    if (loadFromSheetsBtn) {
      loadFromSheetsBtn.addEventListener('click', async () => {
        await loadFromGoogleSheets();
      });
    }

    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode', isDarkMode);
        const themeIcon = document.getElementById('theme-icon');
        if (themeIcon) {
          themeIcon.textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
        }
      });
    }

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.dataset.filter;
        const config = window.elementSdk?.config || defaultConfig;
        renderTransactions(config.currency_symbol || defaultConfig.currency_symbol);
      });
    });

    document.querySelectorAll('.chart-filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.chart-filter-btn').forEach(b => {
          b.classList.remove('active');
          b.style.background = 'var(--bg-secondary)';
          b.style.color = 'var(--text-primary)';
        });
        e.target.classList.add('active');
        e.target.style.background = 'var(--teal)';
        e.target.style.color = 'white';
        currentChartFilter = e.target.dataset.chartFilter;
        updateUI();
      });
    });

    const addTransactionBtn = document.getElementById('add-transaction-btn');
    if (addTransactionBtn) {
      addTransactionBtn.addEventListener('click', () => {
        const modal = document.getElementById('transaction-modal');
        if (modal) {
          modal.classList.add('active');
        }
        
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('transaction-date');
        if (dateInput) {
          dateInput.value = today;
        }
        
        updateCategoryDropdown();
        updatePaymentMethodDropdown();
      });
    }

    function updateCategoryDropdown() {
      try {
        const transactionType = document.getElementById('transaction-type');
        const categorySelect = document.getElementById('transaction-category');
        
        if (!transactionType || !categorySelect) return;
        
        const typeValue = transactionType.value;
        categorySelect.innerHTML = '';
        
        let categories = {};
        if (typeValue === 'income') {
          categories = { ...incomeCategories, ...customCategories.income };
        } else if (typeValue === 'expense') {
          categories = { ...expenseCategories, ...customCategories.expense };
        } else if (typeValue === 'saving') {
          categories = { ...savingCategories, ...customCategories.saving };
        } else if (typeValue === 'investment') {
          categories = { ...investmentCategories, ...customCategories.investment };
        }
        
        Object.keys(categories).forEach(key => {
          const category = categories[key];
          const option = document.createElement('option');
          option.value = key;
          option.textContent = `${category.icon} ${category.name}`;
          option.style.color = 'var(--text-primary)';
          categorySelect.appendChild(option);
        });

        const addNewOption = document.createElement('option');
        addNewOption.value = '__new__';
        addNewOption.textContent = 'â• Buat Kategori Baru';
        addNewOption.style.color = 'var(--teal)';
        addNewOption.style.fontWeight = '600';
        categorySelect.appendChild(addNewOption);
      } catch (error) {
        console.error('Error updating category dropdown:', error);
      }
    }

    function updatePaymentMethodDropdown() {
      try {
        const paymentSelect = document.getElementById('payment-method');
        if (!paymentSelect) return;
        
        paymentSelect.innerHTML = '';
        
        const allMethods = { ...defaultPaymentMethods, ...customPaymentMethods };
        
        Object.keys(allMethods).forEach(key => {
          const method = allMethods[key];
          const option = document.createElement('option');
          option.value = key;
          option.textContent = `${method.icon} ${method.name}`;
          option.style.color = 'var(--text-primary)';
          paymentSelect.appendChild(option);
        });

        const addNewOption = document.createElement('option');
        addNewOption.value = '__new_payment__';
        addNewOption.textContent = 'â• Buat Metode Pembayaran Baru';
        addNewOption.style.color = 'var(--teal)';
        addNewOption.style.fontWeight = '600';
        paymentSelect.appendChild(addNewOption);
      } catch (error) {
        console.error('Error updating payment method dropdown:', error);
      }
    }

    const transactionType = document.getElementById('transaction-type');
    if (transactionType) {
      transactionType.addEventListener('change', updateCategoryDropdown);
    }

    const transactionCategory = document.getElementById('transaction-category');
    if (transactionCategory) {
      transactionCategory.addEventListener('change', (e) => {
        const customForm = document.getElementById('custom-category-form');
        if (customForm) {
          customForm.style.display = e.target.value === '__new__' ? 'block' : 'none';
          const customCategoryName = document.getElementById('custom-category-name');
          if (customCategoryName && e.target.value === '__new__') {
            customCategoryName.value = '';
          }
        }
      });
    }

    const paymentMethod = document.getElementById('payment-method');
    if (paymentMethod) {
      paymentMethod.addEventListener('change', (e) => {
        const customPaymentForm = document.getElementById('custom-payment-form');
        if (customPaymentForm) {
          customPaymentForm.style.display = e.target.value === '__new_payment__' ? 'block' : 'none';
          const customPaymentName = document.getElementById('custom-payment-name');
          if (customPaymentName && e.target.value === '__new_payment__') {
            customPaymentName.value = '';
          }
        }
      });
    }

    const addCustomCategoryBtn = document.getElementById('add-custom-category-btn');
    if (addCustomCategoryBtn) {
      addCustomCategoryBtn.addEventListener('click', () => {
        try {
          const categoryNameInput = document.getElementById('custom-category-name');
          const transactionTypeSelect = document.getElementById('transaction-type');

          if (!categoryNameInput || !transactionTypeSelect) return;

          const categoryName = categoryNameInput.value.trim();
          const transactionTypeValue = transactionTypeSelect.value;

          if (!categoryName) {
            showToast('âš ï¸ Masukkan nama kategori');
            return;
          }

          const categoryKey = categoryName.toLowerCase().replace(/\s+/g, '_');
          
          if (customCategories[transactionTypeValue][categoryKey]) {
            showToast('âš ï¸ Kategori sudah ada');
            return;
          }

          let categoryIcon = 'ğŸ“';
          if (transactionTypeValue === 'income') {
            categoryIcon = 'ğŸ’µ';
          } else if (transactionTypeValue === 'expense') {
            categoryIcon = 'ğŸ’¸';
          } else if (transactionTypeValue === 'saving') {
            categoryIcon = 'ğŸ¦';
          } else if (transactionTypeValue === 'investment') {
            categoryIcon = 'ğŸ’¹';
          }
          
          customCategories[transactionTypeValue][categoryKey] = {
            name: categoryName,
            icon: categoryIcon
          };

          if (!categoryIcons[categoryKey]) {
            categoryIcons[categoryKey] = categoryIcon;
          }

          updateCategoryDropdown();
          
          const categorySelect = document.getElementById('transaction-category');
          if (categorySelect) {
            categorySelect.value = categoryKey;
          }
          
          const customCategoryForm = document.getElementById('custom-category-form');
          if (customCategoryForm) {
            customCategoryForm.style.display = 'none';
          }
          
          categoryNameInput.value = '';
          
          showToast(`âœ… Kategori "${categoryName}" berhasil ditambahkan`);
        } catch (error) {
          console.error('Error adding custom category:', error);
          showToast('âŒ Error menambah kategori');
        }
      });
    }

    const addCustomPaymentBtn = document.getElementById('add-custom-payment-btn');
    if (addCustomPaymentBtn) {
      addCustomPaymentBtn.addEventListener('click', () => {
        try {
          const paymentNameInput = document.getElementById('custom-payment-name');
          if (!paymentNameInput) return;

          const paymentName = paymentNameInput.value.trim();
          const paymentIcon = 'ğŸ’³';

          if (!paymentName) {
            showToast('âš ï¸ Masukkan nama metode pembayaran');
            return;
          }

          const paymentKey = paymentName.toLowerCase().replace(/\s+/g, '_');
          
          customPaymentMethods[paymentKey] = {
            name: paymentName,
            icon: paymentIcon
          };

          updatePaymentMethodDropdown();
          
          const paymentSelect = document.getElementById('payment-method');
          if (paymentSelect) {
            paymentSelect.value = paymentKey;
          }
          
          const customPaymentForm = document.getElementById('custom-payment-form');
          if (customPaymentForm) {
            customPaymentForm.style.display = 'none';
          }
          
          showToast(`âœ… Metode pembayaran "${paymentName}" berhasil ditambahkan`);
        } catch (error) {
          console.error('Error adding custom payment:', error);
          showToast('âŒ Error menambah metode pembayaran');
        }
      });
    }

    const closeModal = document.getElementById('close-modal');
    if (closeModal) {
      closeModal.addEventListener('click', () => {
        const modal = document.getElementById('transaction-modal');
        if (modal) {
          modal.classList.remove('active');
        }
        const form = document.getElementById('transaction-form');
        if (form) {
          form.reset();
        }
        const customCategoryForm = document.getElementById('custom-category-form');
        if (customCategoryForm) {
          customCategoryForm.style.display = 'none';
        }
        const customPaymentForm = document.getElementById('custom-payment-form');
        if (customPaymentForm) {
          customPaymentForm.style.display = 'none';
        }
        isSubmitting = false;
        const submitBtn = document.getElementById('submit-btn');
        if (submitBtn) {
          submitBtn.textContent = 'Simpan Transaksi';
          submitBtn.disabled = false;
        }
      });
    }

    const amountInput = document.getElementById('transaction-amount');
    if (amountInput) {
      amountInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\./g, '');
        
        if (!/^\d*$/.test(value)) {
          value = value.replace(/\D/g, '');
        }
        
        if (value === '') {
          e.target.value = '';
          return;
        }
        
        const formattedValue = parseInt(value).toLocaleString('id-ID');
        e.target.value = formattedValue;
      });

      amountInput.addEventListener('keydown', (e) => {
        const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'];
        if (allowedKeys.includes(e.key) || (e.key >= '0' && e.key <= '9')) {
          return;
        }
        e.preventDefault();
      });
    }

    const transactionForm = document.getElementById('transaction-form');
    if (transactionForm) {
      transactionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (isSubmitting) {
          console.log('âš ï¸ Sudah dalam proses submit, skip');
          return;
        }
        
        if (transactions.length >= 999) {
          showToast('âš ï¸ Maksimum 999 transaksi tercapai. Hapus beberapa transaksi terlebih dahulu.');
          return;
        }

        try {
          const categorySelect = document.getElementById('transaction-category');
          if (!categorySelect) return;
          
          const categoryValue = categorySelect.value;
          if (categoryValue === '__new__') {
            showToast('âš ï¸ Silakan tambahkan kategori baru atau pilih kategori yang ada');
            return;
          }

          const paymentSelect = document.getElementById('payment-method');
          if (!paymentSelect) return;
          
          const paymentValue = paymentSelect.value;
          if (paymentValue === '__new_payment__') {
            showToast('âš ï¸ Silakan tambahkan metode pembayaran baru atau pilih yang ada');
            return;
          }

          const amountInputEl = document.getElementById('transaction-amount');
          if (!amountInputEl) return;
          
          const amountValue = amountInputEl.value.replace(/\./g, '');
          const parsedAmount = parseFloat(amountValue);
          
          if (!parsedAmount || parsedAmount <= 0) {
            showToast('âš ï¸ Masukkan jumlah yang valid');
            return;
          }

          isSubmitting = true;
          const submitBtn = document.getElementById('submit-btn');
          const originalText = submitBtn ? submitBtn.textContent : 'Simpan Transaksi';
          
          if (submitBtn) {
            submitBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
            submitBtn.disabled = true;
          }

          const transactionTypeEl = document.getElementById('transaction-type');
          const transactionDateEl = document.getElementById('transaction-date');
          const transactionDescriptionEl = document.getElementById('transaction-description');
          
          if (!transactionTypeEl || !transactionDateEl) {
            throw new Error('Form elements not found');
          }

          const selectedDate = transactionDateEl.value;
          const transactionDate = selectedDate ? new Date(selectedDate + 'T12:00:00') : new Date();
          
          const newTransaction = {
            id: Date.now().toString(),
            type: transactionTypeEl.value,
            category: categoryValue,
            amount: parsedAmount,
            description: transactionDescriptionEl ? transactionDescriptionEl.value || '' : '',
            payment_method: paymentValue,
            created_at: transactionDate.toISOString()
          };

          console.log('ğŸ“¤ Mengirim transaksi ke Data SDK:', newTransaction);

          const result = await window.dataSdk.create(newTransaction);
          
          console.log('ğŸ“¥ Response dari Data SDK:', result);

          if (result.isOk) {
            console.log('âœ… Transaksi berhasil disimpan ke Data SDK');
            
            if (isGoogleSheetsConnected && googleSheetsUrl) {
              console.log('ğŸ“¤ Mengirim ke Google Sheets...');
              const gsResult = await syncToGoogleSheets(newTransaction);
              
              if (gsResult.success) {
                showToast('âœ… Tersinkronisasi ke Google Sheets');
              } else {
                console.log('âš ï¸ Google Sheets sync failed:', gsResult.message);
                showToast('âš ï¸ Disimpan lokal, gagal sync ke Google Sheets');
              }
            }
            
            const modal = document.getElementById('transaction-modal');
            if (modal) {
              modal.classList.remove('active');
            }
            
            const form = document.getElementById('transaction-form');
            if (form) {
              form.reset();
            }
            
            const customCategoryForm = document.getElementById('custom-category-form');
            if (customCategoryForm) {
              customCategoryForm.style.display = 'none';
            }
            
            const customPaymentForm = document.getElementById('custom-payment-form');
            if (customPaymentForm) {
              customPaymentForm.style.display = 'none';
            }
            
            showToast('âœ… Transaksi berhasil disimpan');
          } else {
            console.error('âŒ Data SDK error:', result.error);
            showToast('âŒ Gagal menyimpan: ' + (result.error?.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('âŒ Exception saat menyimpan:', error);
          showToast('âŒ Error: ' + error.message);
        } finally {
          isSubmitting = false;
          const submitBtn = document.getElementById('submit-btn');
          if (submitBtn) {
            submitBtn.textContent = 'Simpan Transaksi';
            submitBtn.disabled = false;
          }
        }
      });
    }

    const transactionModal = document.getElementById('transaction-modal');
    if (transactionModal) {
      transactionModal.addEventListener('click', (e) => {
        if (e.target.id === 'transaction-modal') {
          transactionModal.classList.remove('active');
          const form = document.getElementById('transaction-form');
          if (form) {
            form.reset();
          }
          const customCategoryForm = document.getElementById('custom-category-form');
          if (customCategoryForm) {
            customCategoryForm.style.display = 'none';
          }
          const customPaymentForm = document.getElementById('custom-payment-form');
          if (customPaymentForm) {
            customPaymentForm.style.display = 'none';
          }
          isSubmitting = false;
          const submitBtn = document.getElementById('submit-btn');
          if (submitBtn) {
            submitBtn.textContent = 'Simpan Transaksi';
            submitBtn.disabled = false;
          }
        }
      });
    }

    const reportBtn = document.getElementById('report-btn');
    if (reportBtn) {
      reportBtn.addEventListener('click', () => {
        const currentDate = new Date();
        const reportMonth = document.getElementById('report-month');
        if (reportMonth) {
          reportMonth.value = currentDate.getMonth();
        }
        
        const reportYear = document.getElementById('report-year');
        if (reportYear) {
          reportYear.innerHTML = '';
          for (let year = 2025; year <= 2040; year++) {
            reportYear.innerHTML += `<option value="${year}">${year}</option>`;
          }
        }
        
        generateReport();
        const modal = document.getElementById('report-modal');
        if (modal) {
          modal.classList.add('active');
        }
      });
    }

    const closeReportModal = document.getElementById('close-report-modal');
    if (closeReportModal) {
      closeReportModal.addEventListener('click', () => {
        const modal = document.getElementById('report-modal');
        if (modal) {
          modal.classList.remove('active');
        }
      });
    }

    const reportMonth = document.getElementById('report-month');
    if (reportMonth) {
      reportMonth.addEventListener('change', generateReport);
    }

    const reportYear = document.getElementById('report-year');
    if (reportYear) {
      reportYear.addEventListener('change', generateReport);
    }

    function generateReport() {
      try {
        const monthSelect = document.getElementById('report-month');
        const yearSelect = document.getElementById('report-year');
        
        if (!monthSelect || !yearSelect) return;
        
        const month = parseInt(monthSelect.value);
        const year = parseInt(yearSelect.value);
        const config = window.elementSdk?.config || defaultConfig;
        const currency = config.currency_symbol || defaultConfig.currency_symbol;

        const monthTransactions = transactions.filter(t => {
          const date = new Date(t.created_at);
          return date.getMonth() === month && date.getFullYear() === year;
        });

        const income = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const expense = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        const saving = monthTransactions.filter(t => t.type === 'saving').reduce((sum, t) => sum + t.amount, 0);
        const investment = monthTransactions.filter(t => t.type === 'investment').reduce((sum, t) => sum + t.amount, 0);
        const balance = income - expense - saving - investment;

        const categoryBreakdown = {};
        monthTransactions.forEach(t => {
          if (!categoryBreakdown[t.category]) {
            categoryBreakdown[t.category] = { income: 0, expense: 0, saving: 0, investment: 0 };
          }
          categoryBreakdown[t.category][t.type] += t.amount;
        });

        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                            'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

        let reportHTML = `
          <div class="app-card p-4 mb-4">
            <h4 class="font-semibold mb-3">Ringkasan ${monthNames[month]} ${year}</h4>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-secondary">Total Pemasukan</span>
                <span class="income-color font-semibold">${formatCurrency(income, currency)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-secondary">Total Pengeluaran</span>
                <span class="expense-color font-semibold">${formatCurrency(expense, currency)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-secondary">Total Tabungan</span>
                <span class="saving-color font-semibold">${formatCurrency(saving, currency)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-secondary">Total Investasi</span>
                <span class="investment-color font-semibold">${formatCurrency(investment, currency)}</span>
              </div>
              <div class="flex justify-between pt-2 border-t" style="border-color: var(--border-color);">
                <span class="font-semibold">Saldo Bersih</span>
                <span class="font-semibold" style="color: ${balance >= 0 ? 'var(--income)' : 'var(--expense)'}">
                  ${formatCurrency(balance, currency)}
                </span>
              </div>
            </div>
          </div>

          <div class="app-card p-4">
            <h4 class="font-semibold mb-3">Breakdown per Kategori</h4>
            <div class="space-y-3">
        `;

        Object.keys(categoryBreakdown).forEach(cat => {
          const catData = categoryBreakdown[cat];
          const transactionType = catData.income > 0 ? 'income' : catData.expense > 0 ? 'expense' : catData.saving > 0 ? 'saving' : 'investment';
          reportHTML += `
            <div class="flex items-center justify-between p-2 rounded" style="background: var(--bg-secondary);">
              <div class="flex items-center gap-2">
                <span class="text-xl">${getIconForCategory(cat, transactionType)}</span>
                <span class="capitalize">${getCategoryName(cat, transactionType)}</span>
              </div>
              <div class="text-right">
                ${catData.income > 0 ? `<div class="text-sm income-color">+${formatCurrency(catData.income, currency)}</div>` : ''}
                ${catData.expense > 0 ? `<div class="text-sm expense-color">-${formatCurrency(catData.expense, currency)}</div>` : ''}
                ${catData.saving > 0 ? `<div class="text-sm saving-color">-${formatCurrency(catData.saving, currency)}</div>` : ''}
                ${catData.investment > 0 ? `<div class="text-sm investment-color">-${formatCurrency(catData.investment, currency)}</div>` : ''}
              </div>
            </div>
          `;
        });

        reportHTML += `
            </div>
          </div>
        `;

        const reportContent = document.getElementById('report-content');
        if (reportContent) {
          reportContent.innerHTML = reportHTML;
        }
      } catch (error) {
        console.error('Error generating report:', error);
      }
    }

    const exportReportBtn = document.getElementById('export-report-btn');
    if (exportReportBtn) {
      exportReportBtn.addEventListener('click', () => {
        try {
          const monthSelect = document.getElementById('report-month');
          const yearSelect = document.getElementById('report-year');
          
          if (!monthSelect || !yearSelect) return;
          
          const month = parseInt(monthSelect.value);
          const year = parseInt(yearSelect.value);
          const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

          const monthTransactions = transactions.filter(t => {
            const date = new Date(t.created_at);
            return date.getMonth() === month && date.getFullYear() === year;
          });

          let csv = 'Tanggal,Kategori,Deskripsi,Tipe,Jumlah,Metode Pembayaran\n';
          monthTransactions.forEach(t => {
            const date = new Date(t.created_at).toLocaleString('id-ID');
            csv += `"${date}","${t.category}","${t.description}","${t.type}","${t.amount}","${t.payment_method}"\n`;
          });

          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `laporan_${monthNames[month]}_${year}.csv`;
          link.click();
          
          showToast('âœ… Laporan berhasil diexport');
        } catch (error) {
          console.error('Error exporting report:', error);
          showToast('âŒ Error export laporan');
        }
      });
    }

    const exportBtn = document.getElementById('export-btn');
    if (exportBtn) {
      exportBtn.addEventListener('click', () => {
        try {
          if (transactions.length === 0) {
            showToast('âš ï¸ Tidak ada data transaksi untuk diekspor');
            return;
          }

          const config = window.elementSdk?.config || defaultConfig;
          const currency = config.currency_symbol || defaultConfig.currency_symbol;

          let csv = 'Tanggal,Waktu,Kode Transaksi,Tipe,Kategori,Jumlah,Keterangan,Metode Pembayaran\n';
          
          const sortedTransactions = [...transactions].sort((a, b) => 
            new Date(b.created_at) - new Date(a.created_at)
          );

          sortedTransactions.forEach(t => {
            const date = new Date(t.created_at);
            const formattedDate = date.toLocaleDateString('id-ID');
            const formattedTime = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const categoryName = getCategoryName(t.category, t.type);
            const paymentMethod = getPaymentMethodName(t.payment_method);
            const typeName = t.type === 'income' ? 'Pemasukan' : 
                             t.type === 'expense' ? 'Pengeluaran' : 
                             t.type === 'saving' ? 'Tabungan' : 'Investasi';
            
            const description = (t.description || '-').replace(/"/g, '""');
            
            csv += `"${formattedDate}","${formattedTime}","${t.id}","${typeName}","${categoryName}","${currency}${t.amount.toLocaleString('id-ID')}","${description}","${paymentMethod}"\n`;
          });

          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          const timestamp = new Date().toISOString().split('T')[0];
          link.download = `ekspor_transaksi_${timestamp}.csv`;
          link.click();
          
          setTimeout(() => URL.revokeObjectURL(link.href), 100);
          
          showToast(`âœ… ${transactions.length} transaksi berhasil diekspor ke CSV`);
        } catch (error) {
          console.error('Error exporting data:', error);
          showToast('âŒ Error saat ekspor data');
        }
      });
    }

    const settingsBtn = document.getElementById('settings-btn');
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        const modal = document.getElementById('settings-modal');
        if (modal) {
          modal.classList.add('active');
        }
        const settingsThemeToggle = document.getElementById('settings-theme-toggle');
        if (settingsThemeToggle) {
          settingsThemeToggle.classList.toggle('active', isDarkMode);
        }
      });
    }

    const closeSettingsModal = document.getElementById('close-settings-modal');
    if (closeSettingsModal) {
      closeSettingsModal.addEventListener('click', () => {
        const modal = document.getElementById('settings-modal');
        if (modal) {
          modal.classList.remove('active');
        }
      });
    }

    const settingsThemeToggle = document.getElementById('settings-theme-toggle');
    if (settingsThemeToggle) {
      settingsThemeToggle.addEventListener('click', () => {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode', isDarkMode);
        const themeIcon = document.getElementById('theme-icon');
        if (themeIcon) {
          themeIcon.textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
        }
        settingsThemeToggle.classList.toggle('active', isDarkMode);
      });
    }

    document.querySelectorAll('.theme-color-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const color = e.target.dataset.color;
        document.querySelectorAll('.theme-color-btn').forEach(b => b.style.border = '2px solid transparent');
        e.target.style.border = '2px solid var(--text-primary)';
        
        document.documentElement.style.setProperty('--teal', color);
        document.documentElement.style.setProperty('--teal-dark', color);
        
        if (window.elementSdk) {
          window.elementSdk.setConfig({ primary_color: color });
        }
        
        showToast('âœ… Tema warna berhasil diubah');
      });
    });

    const backupBtn = document.getElementById('backup-btn');
    if (backupBtn) {
      backupBtn.addEventListener('click', () => {
        try {
          const backupData = {
            version: '1.0',
            date: new Date().toISOString(),
            transactions: transactions,
            config: window.elementSdk?.config || defaultConfig,
            customCategories: customCategories
          };

          const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `backup_keuangan_${new Date().toISOString().split('T')[0]}.json`;
          link.click();
          
          showToast('âœ… Backup berhasil dibuat');
        } catch (error) {
          console.error('Error creating backup:', error);
          showToast('âŒ Error membuat backup');
        }
      });
    }

    const reportModal = document.getElementById('report-modal');
    if (reportModal) {
      reportModal.addEventListener('click', (e) => {
        if (e.target.id === 'report-modal') {
          reportModal.classList.remove('active');
        }
      });
    }

    const settingsModal = document.getElementById('settings-modal');
    if (settingsModal) {
      settingsModal.addEventListener('click', (e) => {
        if (e.target.id === 'settings-modal') {
          settingsModal.classList.remove('active');
        }
      });
    }

    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b4796d151c7b29b',t:'MTc2NjgyNTYyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

